<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SapthaVarnah Admin Panel</title>
    <link rel="icon" type="image/png" href="/sapthavarna-web/assets/logo-Ce9r-tB9.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" crossorigin href="/sapthavarna-web/assets/admin-CCl89y0a.css">
</head>
<body data-theme="dark">
    <!-- Auth Login Overlay -->
    <div class="auth-overlay" id="auth-overlay">
        <div class="auth-card">
            <div class="auth-logo">
                <i class="fas fa-shield-alt"></i>
            </div>
            <h2>Admin Access</h2>
            <p class="auth-subtitle">Enter your access key to continue</p>
            <div class="form-group">
                <input type="password" class="form-control auth-input" id="auth-key" 
                       placeholder="Enter access key..." autocomplete="off">
            </div>
            <button type="button" class="btn btn-primary auth-btn" onclick="verifyAuth()">
                <i class="fas fa-unlock"></i> Authenticate
            </button>
            <div class="auth-error" id="auth-error"></div>
        </div>
    </div>

    <header class="admin-header" id="admin-main" style="display:none;">
        <div class="header-logo-wrap">
            <h1><i class="fas fa-cogs"></i> SapthaVarnah Admin</h1>
        </div>
        <div class="header-actions">
            <button type="button" class="btn btn-secondary btn-icon" onclick="toggleTheme()" title="Toggle Theme">
                <i class="fas fa-moon" id="theme-icon"></i>
            </button>
            <button type="button" class="btn btn-secondary" onclick="openGitHubConfig()">
                <i class="fab fa-github"></i> GitHub
            </button>
            <button type="button" class="btn btn-primary" onclick="loadDataFromGitHub()">
                <i class="fas fa-sync"></i> Load
            </button>
            <button type="button" class="btn btn-success" onclick="publishAllChanges()" id="publish-btn">
                <i class="fas fa-cloud-upload-alt"></i> Publish
            </button>
            <button type="button" class="btn btn-danger btn-icon" onclick="logout()" title="Logout">
                <i class="fas fa-sign-out-alt"></i>
            </button>
            <a href="index.html" class="btn btn-primary">
                <i class="fas fa-external-link-alt"></i> View Site
            </a>
        </div>
    </header>

    <div class="admin-container" id="admin-container" style="display:none;">
        <nav class="sidebar">
            <ul class="sidebar-nav">
                <li><a href="#" class="active" data-section="dashboard"><i class="fas fa-chart-pie"></i> Dashboard</a></li>
                <li><a href="#" data-section="team"><i class="fas fa-users"></i> Team</a></li>
                <li><a href="#" data-section="services"><i class="fas fa-layer-group"></i> Services</a></li>
                <li><a href="#" data-section="locations"><i class="fas fa-map-marker-alt"></i> Locations</a></li>
                <li><a href="#" data-section="content"><i class="fas fa-file-alt"></i> Content</a></li>
                <li><a href="#" data-section="settings"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <!-- Dashboard -->
            <section id="dashboard" class="content-section active">
                <div class="section-header">
                    <h2>Dashboard</h2>
                </div>
                <div class="stats-grid" id="stats-grid"></div>
                <div class="section-header" style="margin-top:30px;">
                    <h2>Quick Actions</h2>
                </div>
                <div style="display:flex; gap:16px; flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="showSection('team'); openAddModal('team')">
                        <i class="fas fa-plus"></i> Add Team Member
                    </button>
                    <button class="btn btn-primary" onclick="showSection('services'); openAddModal('services')">
                        <i class="fas fa-plus"></i> Add Service
                    </button>
                    <button class="btn btn-primary" onclick="showSection('locations'); openAddModal('locations')">
                        <i class="fas fa-plus"></i> Add Location
                    </button>
                </div>
            </section>

            <!-- Team -->
            <section id="team" class="content-section">
                <div class="section-header">
                    <h2>Team Members</h2>
                    <button class="btn btn-primary" onclick="openAddModal('team')">
                        <i class="fas fa-plus"></i> Add Member
                    </button>
                </div>
                <div class="items-grid" id="team-grid"></div>
            </section>

            <!-- Services -->
            <section id="services" class="content-section">
                <div class="section-header">
                    <h2>Services & Capabilities</h2>
                    <button class="btn btn-primary" onclick="openAddModal('services')">
                        <i class="fas fa-plus"></i> Add Service
                    </button>
                </div>
                <div class="items-grid" id="services-grid"></div>
            </section>

            <!-- Locations -->
            <section id="locations" class="content-section">
                <div class="section-header">
                    <h2>Global Locations</h2>
                    <button class="btn btn-primary" onclick="openAddModal('locations')">
                        <i class="fas fa-plus"></i> Add Location
                    </button>
                </div>
                <div class="items-grid" id="locations-grid"></div>
            </section>

            <!-- Content -->
            <section id="content" class="content-section">
                <div class="section-header">
                    <h2>Page Content</h2>
                </div>
                <div class="item-card" style="max-width:800px;">
                    <div class="item-card-content">
                        <p style="color:var(--text-muted);">Edit page content through the main content.js file. Changes here affect all pages.</p>
                        <div class="form-group" style="margin-top:20px;">
                            <label>Hero Title</label>
                            <input type="text" class="form-control" id="hero-title" placeholder="Engineering the Full Spectrum...">
                        </div>
                        <div class="form-group">
                            <label>Hero Subtitle</label>
                            <textarea class="form-control" id="hero-subtitle" placeholder="Company tagline..."></textarea>
                        </div>
                        <button class="btn btn-success" onclick="saveContent()">
                            <i class="fas fa-save"></i> Save Content
                        </button>
                    </div>
                </div>
            </section>

            <!-- Settings -->
            <section id="settings" class="content-section">
                <div class="section-header">
                    <h2>Global Settings</h2>
                    <button class="btn btn-success" onclick="saveSettings()">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
                <div class="item-card" style="max-width:800px;">
                    <div class="item-card-content">
                        <div class="form-group">
                            <label>Company Name</label>
                            <input type="text" class="form-control" id="company-name" value="SapthaVarnah Geo Technologies">
                        </div>
                        <div class="form-group">
                            <label>Contact Email</label>
                            <input type="email" class="form-control" id="contact-email" placeholder="info@svgeotech.com">
                        </div>
                        <div class="form-group">
                            <label>Careers Email</label>
                            <input type="email" class="form-control" id="careers-email" placeholder="careers@svgeotech.com">
                        </div>
                        <div class="form-group">
                            <label>LinkedIn Profile</label>
                            <input type="url" class="form-control" id="linkedin-url" placeholder="https://linkedin.com/company/...">
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">Add Item</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveItem()">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>

    <!-- GitHub Config Modal -->
    <div class="modal-overlay" id="github-config-overlay">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header">
                <h3><i class="fab fa-github"></i> GitHub Configuration</h3>
                <button class="modal-close" onclick="closeGitHubConfig()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color:var(--text-muted); margin-bottom:20px;">
                    Connect to GitHub to save changes directly to your repository.
                </p>
                <div class="form-group">
                    <label>GitHub Owner/Username</label>
                    <input type="text" class="form-control" id="github-owner" placeholder="EnochMacwan" value="EnochMacwan">
                </div>
                <div class="form-group">
                    <label>Repository Name</label>
                    <input type="text" class="form-control" id="github-repo" placeholder="sapthavarna-web" value="sapthavarna-web">
                </div>
                <div class="form-group">
                    <label>Branch</label>
                    <input type="text" class="form-control" id="github-branch" placeholder="master" value="master">
                </div>
                <div class="form-group">
                    <label>Personal Access Token</label>
                    <input type="password" class="form-control" id="github-token" placeholder="ghp_xxxx...">
                    <small style="color:var(--text-muted); display:block; margin-top:8px;">
                        <a href="https://github.com/settings/tokens" target="_blank" style="color:var(--accent);">Generate token</a> with repo permissions.
                    </small>
                </div>
                <div id="github-status"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeGitHubConfig()">Cancel</button>
                <button class="btn btn-primary" onclick="testGitHubConnection()">
                    <i class="fas fa-plug"></i> Test
                </button>
                <button class="btn btn-success" onclick="saveGitHubConfig()">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Load Data Files (non-module) -->
    <script src="web/team-data.js"></script>
    <script src="web/services-data.js"></script>
    <script src="web/locations-data.js"></script>
    <script src="web/settings-data.js"></script>

    <script>
        // ===== AUTHENTICATION =====
        // Access key hash (SHA-256 of "svgt2024")
        const AUTH_KEY_HASH = '5a9afb0e6e8e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a';
        const AUTH_SESSION_KEY = 'svgt_admin_session';
        const AUTH_VALID_HOURS = 24;

        // Simple hash function (for demo - production should use proper crypto)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }

        // Check if user is authenticated
        function checkAuth() {
            const session = localStorage.getItem(AUTH_SESSION_KEY);
            if (!session) return false;
            
            try {
                const data = JSON.parse(session);
                const now = Date.now();
                const hoursElapsed = (now - data.timestamp) / (1000 * 60 * 60);
                
                if (hoursElapsed > AUTH_VALID_HOURS) {
                    localStorage.removeItem(AUTH_SESSION_KEY);
                    return false;
                }
                return data.valid === true;
            } catch (e) {
                return false;
            }
        }

        // Verify auth key
        function verifyAuth() {
            const keyInput = document.getElementById('auth-key');
            const errorDiv = document.getElementById('auth-error');
            const key = keyInput.value.trim();

            // Valid keys: "svgt2024", "admin", or custom set in localStorage
            const validKeys = ['svgt2024', 'admin'];
            const customKey = localStorage.getItem('svgt_custom_auth_key');
            if (customKey) validKeys.push(customKey);

            if (validKeys.includes(key)) {
                // Save session
                localStorage.setItem(AUTH_SESSION_KEY, JSON.stringify({
                    valid: true,
                    timestamp: Date.now()
                }));
                
                // Show admin panel
                showAdminPanel();
            } else {
                errorDiv.textContent = 'Invalid access key. Please try again.';
                keyInput.value = '';
                keyInput.focus();
                
                // Shake animation
                keyInput.style.animation = 'shake 0.3s';
                setTimeout(() => keyInput.style.animation = '', 300);
            }
        }

        // Show admin panel after auth
        function showAdminPanel() {
            document.getElementById('auth-overlay').classList.add('hidden');
            document.getElementById('admin-main').style.display = 'flex';
            document.getElementById('admin-container').style.display = 'flex';
        }

        // Logout
        function logout() {
            localStorage.removeItem(AUTH_SESSION_KEY);
            document.getElementById('auth-overlay').classList.remove('hidden');
            document.getElementById('admin-main').style.display = 'none';
            document.getElementById('admin-container').style.display = 'none';
            document.getElementById('auth-key').value = '';
        }

        // Enter key to submit
        document.getElementById('auth-key')?.addEventListener('keypress', e => {
            if (e.key === 'Enter') verifyAuth();
        });

        // Check auth on load
        if (checkAuth()) {
            showAdminPanel();
        }

        // ===== STATE =====
        let currentSection = 'dashboard';
        let currentEditType = null;
        let currentEditIndex = null;
        let pendingChanges = new Set();

        // GitHub Config
        let gitHubConfig = {};
        try {
            gitHubConfig = JSON.parse(localStorage.getItem('svgt_github_config') || '{}');
        } catch(e) { gitHubConfig = {}; }


        const GITHUB_DATA_FILES = {
            'team': 'web/team-data.js',
            'services': 'web/services-data.js',
            'locations': 'web/locations-data.js',
            'settings': 'web/settings-data.js',
            'content': 'web/content.js'
        };

        const GITHUB_VAR_NAMES = {
            'team': 'TEAM_DATA',
            'services': 'SERVICES_DATA',
            'locations': 'LOCATIONS_DATA',
            'settings': 'SETTINGS_DATA',
            'content': 'defaultContent'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initNavigation();
            renderDashboard();
            renderAllSections();
            loadTheme();
        });

        // Theme
        function toggleTheme() {
            const theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
            document.body.dataset.theme = theme;
            localStorage.setItem('adminTheme', theme);
            document.getElementById('theme-icon').className = theme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
        }

        function loadTheme() {
            const theme = localStorage.getItem('adminTheme') || 'dark';
            document.body.dataset.theme = theme;
            document.getElementById('theme-icon').className = theme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
        }

        // Navigation
        function initNavigation() {
            document.querySelectorAll('.sidebar-nav a').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    showSection(link.dataset.section);
                });
            });
        }

        function showSection(section) {
            document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
            document.querySelector(`[data-section="${section}"]`)?.classList.add('active');
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(section)?.classList.add('active');
            currentSection = section;
        }

        // Dashboard
        function renderDashboard() {
            const stats = [
                { icon: 'fa-users', value: (window.TEAM_DATA || []).length, label: 'Team Members' },
                { icon: 'fa-layer-group', value: (window.SERVICES_DATA || []).length, label: 'Service Areas' },
                { icon: 'fa-map-marker-alt', value: (window.LOCATIONS_DATA || []).length, label: 'Locations' }
            ];

            document.getElementById('stats-grid').innerHTML = stats.map(s => `
                <div class="stat-card">
                    <i class="fas ${s.icon}"></i>
                    <div class="value">${s.value}</div>
                    <div class="label">${s.label}</div>
                </div>
            `).join('');
        }

        // Render All
        function renderAllSections() {
            renderTeam();
            renderServices();
            renderLocations();
        }

        // Get Data
        function getDataArray(type) {
            switch(type) {
                case 'team': return window.TEAM_DATA || [];
                case 'services': return window.SERVICES_DATA || [];
                case 'locations': return window.LOCATIONS_DATA || [];
                default: return [];
            }
        }

        // Render Team
        function renderTeam() {
            const data = window.TEAM_DATA || [];
            const grid = document.getElementById('team-grid');
            if (!grid) return;

            grid.innerHTML = data.map((item, i) => `
                <div class="item-card">
                    <div class="item-card-content">
                        <div class="item-card-header">
                            <h3>${escapeHTML(item.name)}</h3>
                            <span class="category">${escapeHTML(item.role)}</span>
                        </div>
                        <p>${escapeHTML(item.bio || '').substring(0, 100)}...</p>
                        <div class="item-card-actions">
                            <button class="btn btn-secondary btn-icon" onclick="editItem('team', ${i})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-icon" onclick="deleteItem('team', ${i})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('') || '<p style="color:var(--text-muted)">No team members yet.</p>';
        }

        // Render Services
        function renderServices() {
            const data = window.SERVICES_DATA || [];
            const grid = document.getElementById('services-grid');
            if (!grid) return;

            grid.innerHTML = data.map((item, i) => `
                <div class="item-card">
                    <div class="item-card-content">
                        <div class="item-card-header">
                            <h3>${escapeHTML(item.title)}</h3>
                            <span class="category">${escapeHTML(item.category)}</span>
                        </div>
                        <p>${escapeHTML(item.description || '').substring(0, 100)}...</p>
                        <div class="item-card-actions">
                            <button class="btn btn-secondary btn-icon" onclick="editItem('services', ${i})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-icon" onclick="deleteItem('services', ${i})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('') || '<p style="color:var(--text-muted)">No services yet.</p>';
        }

        // Render Locations
        function renderLocations() {
            const data = window.LOCATIONS_DATA || [];
            const grid = document.getElementById('locations-grid');
            if (!grid) return;

            grid.innerHTML = data.map((item, i) => `
                <div class="item-card">
                    <div class="item-card-content">
                        <div class="item-card-header">
                            <h3>${escapeHTML(item.city)}, ${escapeHTML(item.country)}</h3>
                            <span class="category">${escapeHTML(item.type)}</span>
                        </div>
                        <p>${escapeHTML(item.address || '')}</p>
                        <div class="item-card-actions">
                            <button class="btn btn-secondary btn-icon" onclick="editItem('locations', ${i})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-icon" onclick="deleteItem('locations', ${i})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('') || '<p style="color:var(--text-muted)">No locations yet.</p>';
        }

        // Modal Functions
        function openAddModal(type) {
            currentEditType = type;
            currentEditIndex = null;
            document.getElementById('modal-title').textContent = `Add ${capitalize(type.replace('s', ''))}`;
            document.getElementById('modal-body').innerHTML = getFormHTML(type, {});
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function editItem(type, index) {
            currentEditType = type;
            currentEditIndex = index;
            const data = getDataArray(type)[index];
            document.getElementById('modal-title').textContent = `Edit ${capitalize(type.replace('s', ''))}`;
            document.getElementById('modal-body').innerHTML = getFormHTML(type, data);
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            currentEditType = null;
            currentEditIndex = null;
        }

        function getFormHTML(type, data) {
            if (type === 'team') {
                return `
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" class="form-control" id="form-name" value="${escapeHTML(data.name || '')}">
                    </div>
                    <div class="form-group">
                        <label>Role / Title</label>
                        <input type="text" class="form-control" id="form-role" value="${escapeHTML(data.role || '')}">
                    </div>
                    <div class="form-group">
                        <label>Bio</label>
                        <textarea class="form-control" id="form-bio">${escapeHTML(data.bio || '')}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Photo</label>
                        <div class="photo-upload-area">
                            <div class="photo-preview" id="photo-preview">
                                ${data.photo ? `<img src="${data.photo}" alt="Preview">` : '<i class="fas fa-user"></i>'}
                            </div>
                            <div class="photo-controls">
                                <input type="file" id="form-photo-file" accept="image/*" onchange="handlePhotoUpload(this)" style="display:none;">
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('form-photo-file').click()">
                                    <i class="fas fa-upload"></i> Upload Photo
                                </button>
                                <input type="text" class="form-control" id="form-photo" value="${escapeHTML(data.photo || '')}" placeholder="Or enter URL/path">
                            </div>
                        </div>
                    </div>
                `;
            }
            if (type === 'services') {
                return `
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" class="form-control" id="form-title" value="${escapeHTML(data.title || '')}">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <input type="text" class="form-control" id="form-category" value="${escapeHTML(data.category || '')}">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" id="form-description">${escapeHTML(data.description || '')}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Link</label>
                        <input type="text" class="form-control" id="form-link" value="${escapeHTML(data.link || '')}" placeholder="/marine">
                    </div>
                `;
            }
            if (type === 'locations') {
                return `
                    <div class="form-group">
                        <label>Country</label>
                        <input type="text" class="form-control" id="form-country" value="${escapeHTML(data.country || '')}">
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" class="form-control" id="form-city" value="${escapeHTML(data.city || '')}">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <input type="text" class="form-control" id="form-type" value="${escapeHTML(data.type || '')}" placeholder="Headquarters, Office, etc.">
                    </div>
                    <div class="form-group">
                        <label>Full Address</label>
                        <textarea class="form-control" id="form-address">${escapeHTML(data.address || '')}</textarea>
                    </div>
                `;
            }
            return '';
        }

        function saveItem() {
            const data = getDataArray(currentEditType);
            let item = {};

            if (currentEditType === 'team') {
                item = {
                    id: document.getElementById('form-name').value.toLowerCase().replace(/\s+/g, '-'),
                    name: document.getElementById('form-name').value,
                    role: document.getElementById('form-role').value,
                    bio: document.getElementById('form-bio').value,
                    photo: document.getElementById('form-photo').value,
                    order: currentEditIndex !== null ? data[currentEditIndex].order : data.length + 1
                };
            } else if (currentEditType === 'services') {
                item = {
                    id: document.getElementById('form-title').value.toLowerCase().replace(/\s+/g, '-'),
                    title: document.getElementById('form-title').value,
                    category: document.getElementById('form-category').value,
                    description: document.getElementById('form-description').value,
                    link: document.getElementById('form-link').value,
                    services: currentEditIndex !== null ? data[currentEditIndex].services : []
                };
            } else if (currentEditType === 'locations') {
                item = {
                    id: document.getElementById('form-city').value.toLowerCase().replace(/\s+/g, '-'),
                    country: document.getElementById('form-country').value,
                    city: document.getElementById('form-city').value,
                    type: document.getElementById('form-type').value,
                    address: document.getElementById('form-address').value
                };
            }

            if (currentEditIndex !== null) {
                data[currentEditIndex] = item;
            } else {
                data.push(item);
            }

            pendingChanges.add(currentEditType);
            closeModal();
            renderAllSections();
            renderDashboard();
            showToast('Item saved! Click Publish to save to GitHub.');
        }

        function deleteItem(type, index) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            const data = getDataArray(type);
            data.splice(index, 1);
            pendingChanges.add(type);
            renderAllSections();
            renderDashboard();
            showToast('Item deleted.');
        }

        // GitHub Functions
        function openGitHubConfig() {
            document.getElementById('github-owner').value = gitHubConfig.owner || 'EnochMacwan';
            document.getElementById('github-repo').value = gitHubConfig.repo || 'sapthavarna-web';
            document.getElementById('github-branch').value = gitHubConfig.branch || 'master';
            document.getElementById('github-token').value = gitHubConfig.token || '';
            document.getElementById('github-status').innerHTML = '';
            document.getElementById('github-config-overlay').style.display = 'flex';
        }

        function closeGitHubConfig() {
            document.getElementById('github-config-overlay').style.display = 'none';
        }

        function saveGitHubConfig() {
            gitHubConfig = {
                owner: document.getElementById('github-owner').value.trim(),
                repo: document.getElementById('github-repo').value.trim(),
                branch: document.getElementById('github-branch').value.trim(),
                token: document.getElementById('github-token').value.trim()
            };
            localStorage.setItem('svgt_github_config', JSON.stringify(gitHubConfig));
            closeGitHubConfig();
            showToast('GitHub settings saved!', 'success');
        }

        async function testGitHubConnection() {
            const owner = document.getElementById('github-owner').value.trim();
            const repo = document.getElementById('github-repo').value.trim();
            const token = document.getElementById('github-token').value.trim();
            const status = document.getElementById('github-status');

            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            status.style.color = 'var(--text)';

            try {
                const res = await fetch(`https://api.github.com/repos/${owner}/${repo}`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                if (res.ok) {
                    status.innerHTML = '<i class="fas fa-check-circle"></i> Connected!';
                    status.style.color = 'var(--success)';
                } else {
                    status.innerHTML = '<i class="fas fa-times-circle"></i> Connection failed';
                    status.style.color = 'var(--danger)';
                }
            } catch(e) {
                status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error: ' + e.message;
                status.style.color = 'var(--danger)';
            }
        }

        async function loadDataFromGitHub() {
            if (!gitHubConfig.token) {
                showToast('Configure GitHub first', 'error');
                return;
            }
            showToast('Loading from GitHub...', 'info');

            for (const type of Object.keys(GITHUB_DATA_FILES)) {
                try {
                    const res = await fetch(
                        `https://raw.githubusercontent.com/${gitHubConfig.owner}/${gitHubConfig.repo}/${gitHubConfig.branch}/${GITHUB_DATA_FILES[type]}`
                    );
                    if (res.ok) {
                        const content = await res.text();
                        const match = content.match(/(?:const\s+\w+|window\.\w+)\s*=\s*(\{[\s\S]*?\}|\[[\s\S]*?\])\s*;/);
                        if (match) {
                            const data = new Function('return ' + match[1])();
                            window[GITHUB_VAR_NAMES[type]] = data;
                        }
                    }
                } catch(e) {
                    console.log(`Could not load ${type}:`, e);
                }
            }

            renderDashboard();
            renderAllSections();
            showToast('Data loaded from GitHub!', 'success');
        }

        async function publishAllChanges() {
            if (!gitHubConfig.token) {
                showToast('Configure GitHub first', 'error');
                return;
            }

            if (pendingChanges.size === 0) {
                showToast('No changes to publish', 'info');
                return;
            }

            showToast('Publishing to GitHub...', 'info');

            for (const type of pendingChanges) {
                await saveToGitHub(type, getDataArray(type));
            }

            pendingChanges.clear();
            showToast('Published successfully!', 'success');
        }

        async function saveToGitHub(type, data) {
            const filePath = GITHUB_DATA_FILES[type];
            const varName = GITHUB_VAR_NAMES[type];
            if (!filePath || !varName) return;

            const fileContent = `const ${varName} = ${JSON.stringify(data, null, 2)};`;

            // Get current SHA
            const apiUrl = `https://api.github.com/repos/${gitHubConfig.owner}/${gitHubConfig.repo}/contents/${filePath}`;
            let sha = null;
            try {
                const getRes = await fetch(apiUrl, {
                    headers: { 'Authorization': `token ${gitHubConfig.token}` }
                });
                if (getRes.ok) {
                    const fileData = await getRes.json();
                    sha = fileData.sha;
                }
            } catch(e) {}

            // Update file
            const body = {
                message: `Update ${type} via Admin Panel`,
                content: btoa(unescape(encodeURIComponent(fileContent))),
                branch: gitHubConfig.branch
            };
            if (sha) body.sha = sha;

            await fetch(apiUrl, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${gitHubConfig.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });
        }

        // Utilities
        function escapeHTML(str) {
            if (typeof str !== 'string') return str;
            return str.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c]));
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Handle photo upload from device
        function handlePhotoUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showToast('Please select an image file', 'error');
                return;
            }

            // Validate file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast('Image must be under 2MB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                
                // Update preview
                const preview = document.getElementById('photo-preview');
                if (preview) {
                    preview.innerHTML = `<img src="${base64}" alt="Preview">`;
                }
                
                // Update hidden field with base64 data
                const photoInput = document.getElementById('form-photo');
                if (photoInput) {
                    photoInput.value = base64;
                }
                
                showToast('Photo uploaded!', 'success');
            };
            reader.readAsDataURL(file);
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle'}"></i> ${message}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
    </script>
</body>
</html>
