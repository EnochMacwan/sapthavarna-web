<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SapthaVarnah Admin Panel</title>
    <link rel="icon" type="image/png" href="/sapthavarna-web/assets/logo-Ce9r-tB9.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" crossorigin href="/sapthavarna-web/assets/admin-CkaU1tYW.css">
</head>
<body data-theme="dark">
    <!-- Auth Login Overlay -->
    <div class="auth-overlay" id="auth-overlay">
        <div class="auth-card">
            <div class="auth-logo">
                <i class="fas fa-shield-alt"></i>
            </div>
            <h2>Admin Access</h2>
            <p class="auth-subtitle">Enter your access key to continue</p>
            <div class="form-group">
                <input type="password" class="form-control auth-input" id="auth-key" 
                       placeholder="Enter access key..." autocomplete="off">
            </div>
            <button type="button" class="btn btn-primary auth-btn" onclick="verifyAuth()">
                <i class="fas fa-unlock"></i> Authenticate
            </button>
            <div class="auth-error" id="auth-error"></div>
        </div>
    </div>

    <header class="admin-header" id="admin-main" style="display:none;">
        <div class="header-logo-wrap">
            <h1><i class="fas fa-cogs"></i> SapthaVarnah Admin</h1>
        </div>
        <div class="header-actions">
            <button type="button" class="btn btn-secondary btn-icon" onclick="toggleTheme()" title="Toggle Theme">
                <i class="fas fa-moon" id="theme-icon"></i>
            </button>
            <button type="button" class="btn btn-secondary" onclick="openGitHubConfig()">
                <i class="fab fa-github"></i> GitHub
            </button>
            <button type="button" class="btn btn-primary" onclick="loadDataFromGitHub()">
                <i class="fas fa-sync"></i> Load
            </button>
            <button type="button" class="btn btn-success" onclick="publishAllChanges()" id="publish-btn">
                <i class="fas fa-cloud-upload-alt"></i> Publish
            </button>
            <button type="button" class="btn btn-danger btn-icon" onclick="logout()" title="Logout">
                <i class="fas fa-sign-out-alt"></i>
            </button>
            <a href="index.html" class="btn btn-primary">
                <i class="fas fa-external-link-alt"></i> View Site
            </a>
        </div>
    </header>

    <div class="admin-container" id="admin-container" style="display:none;">
        <nav class="sidebar">
            <ul class="sidebar-nav">
                <li><a href="#" class="active" data-section="dashboard"><i class="fas fa-chart-pie"></i> Dashboard</a></li>
                <li><a href="#" data-section="team"><i class="fas fa-users"></i> Team</a></li>
                <li><a href="#" data-section="services"><i class="fas fa-layer-group"></i> Services</a></li>
                <li><a href="#" data-section="locations"><i class="fas fa-map-marker-alt"></i> Locations</a></li>
                <li><a href="#" data-section="projects"><i class="fas fa-project-diagram"></i> Projects</a></li>
                <li><a href="#" data-section="testimonials"><i class="fas fa-quote-right"></i> Testimonials</a></li>
                <li><a href="#" data-section="content"><i class="fas fa-file-alt"></i> Content</a></li>
                <li><a href="#" data-section="visibility"><i class="fas fa-eye"></i> Visibility</a></li>
                <li><a href="#" data-section="navigation"><i class="fas fa-bars"></i> Navigation</a></li>
                <li><a href="#" data-section="settings"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <!-- Dashboard -->
            <section id="dashboard" class="content-section active">
                <div class="section-header">
                    <h2>Dashboard</h2>
                </div>
                <div class="stats-grid" id="stats-grid"></div>
                <div class="section-header section-header-spaced">
                    <h2>Quick Actions</h2>
                </div>
                <div class="quick-actions">
                    <button type="button" class="btn btn-primary" onclick="showSection('team'); openAddModal('team')">
                        <i class="fas fa-plus"></i> Add Team Member
                    </button>
                    <button type="button" class="btn btn-primary" onclick="showSection('services'); openAddModal('services')">
                        <i class="fas fa-plus"></i> Add Service
                    </button>
                    <button type="button" class="btn btn-primary" onclick="showSection('locations'); openAddModal('locations')">
                        <i class="fas fa-plus"></i> Add Location
                    </button>
                    <button type="button" class="btn btn-primary" onclick="showSection('projects'); openAddModal('projects')">
                        <i class="fas fa-plus"></i> Add Project
                    </button>
                    <button type="button" class="btn btn-primary" onclick="showSection('testimonials'); openAddModal('testimonials')">
                        <i class="fas fa-plus"></i> Add Testimonial
                    </button>
                </div>
            </section>

            <!-- Team -->
            <section id="team" class="content-section">
                <div class="section-header">
                    <h2>Team Members</h2>
                    <button type="button" class="btn btn-primary" onclick="openAddModal('team')">
                        <i class="fas fa-plus"></i> Add Member
                    </button>
                </div>
                <div class="items-grid" id="team-grid"></div>
            </section>

            <!-- Services -->
            <section id="services" class="content-section">
                <div class="section-header">
                    <h2>Services &amp; Capabilities</h2>
                    <button type="button" class="btn btn-primary" onclick="openAddModal('services')">
                        <i class="fas fa-plus"></i> Add Service
                    </button>
                </div>
                <div class="items-grid" id="services-grid"></div>
            </section>

            <!-- Locations -->
            <section id="locations" class="content-section">
                <div class="section-header">
                    <h2>Global Locations</h2>
                    <button type="button" class="btn btn-primary" onclick="openAddModal('locations')">
                        <i class="fas fa-plus"></i> Add Location
                    </button>
                </div>
                <div class="items-grid" id="locations-grid"></div>
            </section>

            <!-- Projects -->
            <section id="projects" class="content-section">
                <div class="section-header">
                    <h2>Projects</h2>
                    <button type="button" class="btn btn-primary" onclick="openAddModal('projects')">
                        <i class="fas fa-plus"></i> Add Project
                    </button>
                </div>
                <div class="items-grid" id="projects-grid"></div>
            </section>

            <!-- Testimonials -->
            <section id="testimonials" class="content-section">
                <div class="section-header">
                    <h2>Testimonials</h2>
                    <button type="button" class="btn btn-primary" onclick="openAddModal('testimonials')">
                        <i class="fas fa-plus"></i> Add Testimonial
                    </button>
                </div>
                <div class="items-grid" id="testimonials-grid"></div>
            </section>

            <!-- Content -->
            <section id="content" class="content-section">
                <div class="section-header">
                    <h2>Page Content</h2>
                    <div class="content-header-actions">
                        <button type="button" class="btn btn-secondary" onclick="resetContentToDefaults()">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button type="button" class="btn btn-primary" onclick="previewContent()">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                        <button type="button" class="btn btn-success" onclick="saveAllContent()">
                            <i class="fas fa-save"></i> Save Content
                        </button>
                    </div>
                </div>
                <div class="content-page-tabs" id="content-page-tabs"></div>
                <div id="content-editor-area"></div>
            </section>

            <!-- Visibility -->
            <section id="visibility" class="content-section">
                <div class="section-header">
                    <h2>Section Visibility</h2>
                    <div class="content-header-actions">
                        <button type="button" class="btn btn-secondary" onclick="resetVisibility()"><i class="fas fa-undo"></i> Show All</button>
                        <button type="button" class="btn btn-success" onclick="saveVisibility()"><i class="fas fa-save"></i> Save</button>
                    </div>
                </div>
                <p class="text-muted mb-20">Toggle sections on/off for each page. Disabled sections won't render on the live site.</p>
                <div id="visibility-editor"></div>
            </section>

            <!-- Navigation -->
            <section id="navigation" class="content-section">
                <div class="section-header">
                    <h2>Mega Menu Navigation</h2>
                    <button type="button" class="btn btn-success" onclick="saveNavigation()">
                        <i class="fas fa-save"></i> Save Navigation
                    </button>
                </div>
                <p class="text-muted mb-20">Manage the site's mega menu structure. Changes are published to GitHub with the Publish button.</p>
                <div id="nav-mega-menus"></div>
                <div class="section-header section-header-spaced">
                    <h3>Standalone Links</h3>
                    <button type="button" class="btn btn-primary" onclick="addStandaloneLink()">
                        <i class="fas fa-plus"></i> Add Link
                    </button>
                </div>
                <div id="nav-standalone-links"></div>
            </section>

            <!-- Settings -->
            <section id="settings" class="content-section">
                <div class="section-header">
                    <h2>Global Settings</h2>
                    <button type="button" class="btn btn-success" onclick="saveSettings()">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
                <div class="item-card card-wide">
                    <div class="item-card-content">
                        <div class="form-group">
                            <label>Company Name</label>
                            <input type="text" class="form-control" id="company-name" value="SapthaVarnah Geo Technologies">
                        </div>
                        <div class="form-group">
                            <label>Contact Email</label>
                            <input type="email" class="form-control" id="contact-email" placeholder="info@svgeotech.com">
                        </div>
                        <div class="form-group">
                            <label>Careers Email</label>
                            <input type="email" class="form-control" id="careers-email" placeholder="careers@svgeotech.com">
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" class="form-control" id="phone-number" placeholder="+230 XXX XXXX">
                        </div>
                        <div class="form-group">
                            <label>LinkedIn URL</label>
                            <input type="url" class="form-control" id="linkedin-url" placeholder="https://linkedin.com/company/...">
                        </div>
                        <div class="form-group">
                            <label>Twitter / X URL</label>
                            <input type="url" class="form-control" id="twitter-url" placeholder="https://twitter.com/...">
                        </div>
                        <div class="form-group">
                            <label>YouTube URL</label>
                            <input type="url" class="form-control" id="youtube-url" placeholder="https://youtube.com/@...">
                        </div>
                    </div>
                </div>

                <!-- AI Configuration -->
                <div class="item-card card-wide mt-20">
                    <div class="item-card-content">
                        <h3 class="card-title-accent"><i class="fas fa-robot"></i> AI Assistant (Groq)</h3>
                        <div class="form-group">
                            <label>Groq API Key</label>
                            <input type="password" class="form-control" id="groq-api-key" placeholder="gsk_xxxx...">
                            <small class="form-hint">
                                <a href="https://console.groq.com/keys" target="_blank" rel="noopener">Get free API key</a> - 14,400+ requests/day free
                            </small>
                        </div>
                        <div class="form-group">
                            <label>AI Model</label>
                            <select class="form-control" id="groq-model">
                                <option value="llama-3.3-70b-versatile">Llama 3.3 70B (Best Quality)</option>
                                <option value="llama-3.1-8b-instant">Llama 3.1 8B (Faster)</option>
                                <option value="mixtral-8x7b-32768">Mixtral 8x7B (Balanced)</option>
                            </select>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="saveAIConfig()">
                            <i class="fas fa-save"></i> Save AI Settings
                        </button>
                        <button type="button" class="btn btn-secondary ml-10" onclick="testAI()">
                            <i class="fas fa-vial"></i> Test Connection
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">Add Item</h3>
                <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveItem()">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>

    <!-- GitHub Config Modal -->
    <div class="modal-overlay" id="github-config-overlay">
        <div class="modal modal-sm">
            <div class="modal-header">
                <h3><i class="fab fa-github"></i> GitHub Configuration</h3>
                <button type="button" class="modal-close" onclick="closeGitHubConfig()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-20">
                    Connect to GitHub to save changes directly to your repository.
                </p>
                <div class="form-group">
                    <label>GitHub Owner/Username</label>
                    <input type="text" class="form-control" id="github-owner" placeholder="EnochMacwan" value="EnochMacwan">
                </div>
                <div class="form-group">
                    <label>Repository Name</label>
                    <input type="text" class="form-control" id="github-repo" placeholder="sapthavarna-web" value="sapthavarna-web">
                </div>
                <div class="form-group">
                    <label>Branch</label>
                    <input type="text" class="form-control" id="github-branch" placeholder="master" value="master">
                </div>
                <div class="form-group">
                    <label>Personal Access Token</label>
                    <input type="password" class="form-control" id="github-token" placeholder="ghp_xxxx...">
                    <small class="form-hint">
                        <a href="https://github.com/settings/tokens" target="_blank" rel="noopener">Generate token</a> with repo permissions.
                    </small>
                </div>
                <div id="github-status"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeGitHubConfig()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="testGitHubConnection()">
                    <i class="fas fa-plug"></i> Test
                </button>
                <button type="button" class="btn btn-success" onclick="saveGitHubConfig()">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Load Data Files (non-module) -->
    <script src="web/team-data.js"></script>
    <script src="web/services-data.js"></script>
    <script src="web/locations-data.js"></script>
    <script src="web/settings-data.js"></script>
    <script src="web/nav-data.js"></script>

    <script>
        // ===== AUTHENTICATION =====
        // Access key hash (SHA-256 of "svgt2024")
        const AUTH_KEY_HASH = '5a9afb0e6e8e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a';
        const AUTH_SESSION_KEY = 'svgt_admin_session';
        const AUTH_VALID_HOURS = 24;

        // Simple hash function (for demo - production should use proper crypto)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }

        // Check if user is authenticated
        function checkAuth() {
            const session = localStorage.getItem(AUTH_SESSION_KEY);
            if (!session) return false;
            
            try {
                const data = JSON.parse(session);
                const now = Date.now();
                const hoursElapsed = (now - data.timestamp) / (1000 * 60 * 60);
                
                if (hoursElapsed > AUTH_VALID_HOURS) {
                    localStorage.removeItem(AUTH_SESSION_KEY);
                    return false;
                }
                return data.valid === true;
            } catch (e) {
                return false;
            }
        }

        // Verify auth key
        function verifyAuth() {
            const keyInput = document.getElementById('auth-key');
            const errorDiv = document.getElementById('auth-error');
            const key = keyInput.value.trim();

            // Valid keys: "svgt2024", "admin", or custom set in localStorage
            const validKeys = ['svgt2024', 'admin'];
            const customKey = localStorage.getItem('svgt_custom_auth_key');
            if (customKey) validKeys.push(customKey);

            if (validKeys.includes(key)) {
                // Save session
                localStorage.setItem(AUTH_SESSION_KEY, JSON.stringify({
                    valid: true,
                    timestamp: Date.now()
                }));
                
                // Show admin panel
                showAdminPanel();
            } else {
                errorDiv.textContent = 'Invalid access key. Please try again.';
                keyInput.value = '';
                keyInput.focus();
                
                // Shake animation
                keyInput.style.animation = 'shake 0.3s';
                setTimeout(() => keyInput.style.animation = '', 300);
            }
        }

        // Show admin panel after auth
        function showAdminPanel() {
            document.getElementById('auth-overlay').classList.add('hidden');
            document.getElementById('admin-main').style.display = 'flex';
            document.getElementById('admin-container').style.display = 'flex';
        }

        // Logout
        function logout() {
            localStorage.removeItem(AUTH_SESSION_KEY);
            document.getElementById('auth-overlay').classList.remove('hidden');
            document.getElementById('admin-main').style.display = 'none';
            document.getElementById('admin-container').style.display = 'none';
            document.getElementById('auth-key').value = '';
        }

        // Enter key to submit
        document.getElementById('auth-key')?.addEventListener('keypress', e => {
            if (e.key === 'Enter') verifyAuth();
        });

        // Check auth on load
        if (checkAuth()) {
            showAdminPanel();
        }

        // ===== STATE =====
        let currentSection = 'dashboard';
        let currentEditType = null;
        let currentEditIndex = null;
        let pendingChanges = new Set();

        // GitHub Config
        let gitHubConfig = {};
        try {
            gitHubConfig = JSON.parse(localStorage.getItem('svgt_github_config') || '{}');
        } catch(e) { gitHubConfig = {}; }


        const GITHUB_DATA_FILES = {
            'team': 'web/team-data.js',
            'services': 'web/services-data.js',
            'locations': 'web/locations-data.js',
            'settings': 'web/settings-data.js',
            'content': 'web/content.js',
            'navigation': 'web/nav-data.js'
        };

        const GITHUB_VAR_NAMES = {
            'team': 'TEAM_DATA',
            'services': 'SERVICES_DATA',
            'locations': 'LOCATIONS_DATA',
            'settings': 'SETTINGS_DATA',
            'content': 'defaultContent',
            'navigation': 'NAV_DATA'
        };

        // Content editor state
        let contentWorkingCopy = null;
        let currentContentPage = 'home';

        // ===== CONTENT SCHEMA =====
        const CONTENT_SCHEMA = {
            home: {
                label: 'Home', icon: 'fa-home',
                sections: {
                    hero: { label: 'Hero Section', fields: {
                        title: { type: 'text', label: 'Hero Title' },
                        subtitle: { type: 'textarea', label: 'Hero Subtitle' },
                        ctaMain: { type: 'text', label: 'Primary CTA Text' },
                        ctaSec: { type: 'text', label: 'Secondary CTA Text' }
                    }},
                    about: { label: 'About Preview', fields: {
                        title: { type: 'text', label: 'Section Title' },
                        desc1: { type: 'textarea', label: 'Description Paragraph 1' },
                        desc2: { type: 'textarea', label: 'Description Paragraph 2' }
                    }},
                    capabilities: { label: 'Capability Cards', type: 'array', itemLabel: 'Capability', fields: {
                        title: { type: 'text', label: 'Title' },
                        desc: { type: 'textarea', label: 'Description' },
                        link: { type: 'text', label: 'Link (hash route)' }
                    }},
                    closing: { label: 'Closing Section', fields: {
                        title: { type: 'text', label: 'Closing Statement' },
                        cta: { type: 'text', label: 'CTA Button Text' }
                    }},
                    stats: { label: 'Key Stats', type: 'array', itemLabel: 'Stat', fields: {
                        icon: { type: 'text', label: 'Icon (e.g. fa-anchor)' },
                        value: { type: 'text', label: 'Value' },
                        label: { type: 'text', label: 'Label' }
                    }},
                    clientLogos: { label: 'Client Logos', type: 'array', itemLabel: 'Client', fields: {
                        name: { type: 'text', label: 'Client Name' }
                    }},
                    process: { label: 'How We Work', fields: {
                        title: { type: 'text', label: 'Section Title' },
                        steps: { type: 'array', itemLabel: 'Step', fields: {
                            icon: { type: 'text', label: 'Icon (e.g. fa-search)' },
                            title: { type: 'text', label: 'Step Title' },
                            desc: { type: 'textarea', label: 'Description' }
                        }}
                    }},
                    testimonials: { label: 'Testimonials', type: 'array', itemLabel: 'Testimonial', fields: {
                        quote: { type: 'textarea', label: 'Quote' },
                        name: { type: 'text', label: 'Name' },
                        role: { type: 'text', label: 'Role' },
                        company: { type: 'text', label: 'Company' }
                    }},
                    trustStrip: { label: 'Trust Strip', fields: {
                        title: { type: 'text', label: 'Section Title' },
                        badges: { type: 'array', itemLabel: 'Badge', fields: {
                            icon: { type: 'text', label: 'Icon (e.g. fa-certificate)' },
                            label: { type: 'text', label: 'Badge Label' }
                        }}
                    }},
                    projects: { label: 'Featured Projects', type: 'array', itemLabel: 'Project', fields: {
                        title: { type: 'text', label: 'Project Title' },
                        sector: { type: 'text', label: 'Sector (e.g. marine, transport)' },
                        location: { type: 'text', label: 'Location' },
                        desc: { type: 'textarea', label: 'Description' }
                    }}
                }
            },
            about: {
                label: 'About', icon: 'fa-building',
                sections: {
                    hero: { label: 'Hero', fields: {
                        label: { type: 'text', label: 'Page Label' },
                        title: { type: 'text', label: 'Page Title' }
                    }},
                    company: { label: 'Company Description', fields: {
                        title: { type: 'text', label: 'Section Title' },
                        desc1: { type: 'textarea', label: 'Paragraph 1' },
                        desc2: { type: 'textarea', label: 'Paragraph 2' },
                        desc3: { type: 'textarea', label: 'Paragraph 3' }
                    }},
                    leadershipTeam: { label: 'Leadership Team', type: 'array', itemLabel: 'Leader', fields: {
                        name: { type: 'text', label: 'Name' },
                        role: { type: 'text', label: 'Role' },
                        desc: { type: 'textarea', label: 'Bio' }
                    }},
                    culture: { label: 'Culture & Values', fields: {
                        title: { type: 'text', label: 'Section Title' },
                        desc1: { type: 'textarea', label: 'Description 1' },
                        desc2: { type: 'textarea', label: 'Description 2' },
                        values: { type: 'stringArray', label: 'Core Values' }
                    }},
                    careers: { label: 'Careers', fields: {
                        title: { type: 'text', label: 'Section Title' },
                        desc: { type: 'textarea', label: 'Description' },
                        ctaText: { type: 'text', label: 'CTA Button Text' },
                        ctaEmail: { type: 'text', label: 'CTA Email' }
                    }},
                    timeline: { label: 'Company Timeline', type: 'array', itemLabel: 'Milestone', fields: {
                        year: { type: 'text', label: 'Year' },
                        title: { type: 'text', label: 'Milestone Title' },
                        desc: { type: 'textarea', label: 'Description' }
                    }},
                    certifications: { label: 'Certifications', type: 'array', itemLabel: 'Certification', fields: {
                        icon: { type: 'text', label: 'Icon (e.g. fa-certificate)' },
                        title: { type: 'text', label: 'Certification Title' }
                    }},
                    partners: { label: 'Partners', type: 'array', itemLabel: 'Partner', fields: {
                        name: { type: 'text', label: 'Partner Name' }
                    }}
                }
            },
            capabilities: {
                label: 'Capabilities', icon: 'fa-th-large',
                sections: {
                    hero: { label: 'Hero', fields: {
                        label: { type: 'text', label: 'Page Label' },
                        title: { type: 'text', label: 'Page Title' }
                    }},
                    overview: { label: 'Overview', fields: {
                        desc: { type: 'textarea', label: 'Overview Description' }
                    }},
                    sectors: { label: 'Sector Cards', type: 'array', itemLabel: 'Sector', fields: {
                        id: { type: 'text', label: 'ID (slug)' },
                        label: { type: 'text', label: 'Label' },
                        title: { type: 'text', label: 'Title' },
                        desc: { type: 'textarea', label: 'Description' },
                        link: { type: 'text', label: 'Link' }
                    }},
                    differentiators: { label: 'Differentiators', type: 'array', itemLabel: 'Differentiator', fields: {
                        icon: { type: 'text', label: 'Icon (e.g. fa-globe-africa)' },
                        title: { type: 'text', label: 'Title' },
                        desc: { type: 'textarea', label: 'Description' }
                    }},
                    methodology: { label: 'Methodology', fields: {
                        title: { type: 'text', label: 'Section Title' },
                        steps: { type: 'array', itemLabel: 'Step', fields: {
                            icon: { type: 'text', label: 'Icon (e.g. fa-search)' },
                            title: { type: 'text', label: 'Step Title' },
                            desc: { type: 'textarea', label: 'Description' }
                        }}
                    }}
                }
            },
            marine: {
                label: 'Marine', icon: 'fa-water',
                sections: {
                    hero: { label: 'Hero', fields: {
                        label: { type: 'text', label: 'Page Label' },
                        title: { type: 'text', label: 'Page Title' }
                    }},
                    intro: { label: 'Introduction', fields: {
                        desc: { type: 'textarea', label: 'Intro Description' }
                    }},
                    services: { label: 'Services', type: 'array', itemLabel: 'Service', fields: {
                        title: { type: 'text', label: 'Service Title' },
                        desc: { type: 'textarea', label: 'Description' }
                    }},
                    sectorStats: { label: 'Sector Statistics', type: 'array', itemLabel: 'Stat', fields: {
                        value: { type: 'text', label: 'Value' },
                        label: { type: 'text', label: 'Label' }
                    }},
                    featuredProject: { label: 'Featured Project', fields: {
                        title: { type: 'text', label: 'Project Title' },
                        location: { type: 'text', label: 'Location' },
                        desc: { type: 'textarea', label: 'Description' }
                    }},
                    whyChooseUs: { label: 'Why Choose Us', type: 'array', itemLabel: 'Reason', fields: {
                        icon: { type: 'text', label: 'Icon (e.g. fa-water)' },
                        title: { type: 'text', label: 'Title' },
                        desc: { type: 'textarea', label: 'Description' }
                    }}
                }
            },
            transport: {
                label: 'Transport', icon: 'fa-road',
                sections: {
                    hero: { label: 'Hero', fields: {
                        label: { type: 'text', label: 'Page Label' },
                        title: { type: 'text', label: 'Page Title' }
                    }},
                    intro: { label: 'Introduction', fields: {
                        desc: { type: 'textarea', label: 'Intro Description' }
                    }},
                    services: { label: 'Services', type: 'array', itemLabel: 'Service', fields: {
                        title: { type: 'text', label: 'Service Title' },
                        desc: { type: 'textarea', label: 'Description' }
                    }},
                    sectorStats: { label: 'Sector Statistics', type: 'array', itemLabel: 'Stat', fields: {
                        value: { type: 'text', label: 'Value' },
                        label: { type: 'text', label: 'Label' }
                    }},
                    featuredProject: { label: 'Featured Project', fields: {
                        title: { type: 'text', label: 'Project Title' },
                        location: { type: 'text', label: 'Location' },
                        desc: { type: 'textarea', label: 'Description' }
                    }},
                    whyChooseUs: { label: 'Why Choose Us', type: 'array', itemLabel: 'Reason', fields: {
                        icon: { type: 'text', label: 'Icon' },
                        title: { type: 'text', label: 'Title' },
                        desc: { type: 'textarea', label: 'Description' }
                    }}
                }
            },
            energy: {
                label: 'Energy', icon: 'fa-bolt',
                sections: {
                    hero: { label: 'Hero', fields: {
                        label: { type: 'text', label: 'Page Label' },
                        title: { type: 'text', label: 'Page Title' }
                    }},
                    intro: { label: 'Introduction', fields: {
                        desc: { type: 'textarea', label: 'Intro Description' }
                    }},
                    services: { label: 'Services', type: 'array', itemLabel: 'Service', fields: {
                        title: { type: 'text', label: 'Service Title' },
                        desc: { type: 'textarea', label: 'Description' }
                    }},
                    sectorStats: { label: 'Sector Statistics', type: 'array', itemLabel: 'Stat', fields: {
                        value: { type: 'text', label: 'Value' },
                        label: { type: 'text', label: 'Label' }
                    }},
                    featuredProject: { label: 'Featured Project', fields: {
                        title: { type: 'text', label: 'Project Title' },
                        location: { type: 'text', label: 'Location' },
                        desc: { type: 'textarea', label: 'Description' }
                    }},
                    whyChooseUs: { label: 'Why Choose Us', type: 'array', itemLabel: 'Reason', fields: {
                        icon: { type: 'text', label: 'Icon' },
                        title: { type: 'text', label: 'Title' },
                        desc: { type: 'textarea', label: 'Description' }
                    }}
                }
            },
            systems: {
                label: 'Systems', icon: 'fa-cubes',
                sections: {
                    hero: { label: 'Hero', fields: {
                        label: { type: 'text', label: 'Page Label' },
                        title: { type: 'text', label: 'Page Title' }
                    }},
                    intro: { label: 'Introduction', fields: {
                        desc: { type: 'textarea', label: 'Intro Description' }
                    }},
                    technologies: { label: 'Technologies', type: 'array', itemLabel: 'Technology', fields: {
                        title: { type: 'text', label: 'Title' },
                        desc: { type: 'textarea', label: 'Description' },
                        image: { type: 'text', label: 'Image filename' }
                    }},
                    benefits: { label: 'Benefits', type: 'stringArray', itemLabel: 'Benefit' },
                    sectorStats: { label: 'Sector Statistics', type: 'array', itemLabel: 'Stat', fields: {
                        value: { type: 'text', label: 'Value' },
                        label: { type: 'text', label: 'Label' }
                    }},
                    featuredProject: { label: 'Featured Project', fields: {
                        title: { type: 'text', label: 'Project Title' },
                        location: { type: 'text', label: 'Location' },
                        desc: { type: 'textarea', label: 'Description' }
                    }},
                    whyChooseUs: { label: 'Why Choose Us', type: 'array', itemLabel: 'Reason', fields: {
                        icon: { type: 'text', label: 'Icon' },
                        title: { type: 'text', label: 'Title' },
                        desc: { type: 'textarea', label: 'Description' }
                    }}
                }
            },
            sustainability: {
                label: 'Sustainability', icon: 'fa-leaf',
                sections: {
                    hero: { label: 'Hero', fields: {
                        label: { type: 'text', label: 'Page Label' },
                        title: { type: 'text', label: 'Page Title' }
                    }},
                    plan: { label: 'Sustainability Plan', fields: {
                        title: { type: 'text', label: 'Plan Title' },
                        desc: { type: 'textarea', label: 'Plan Description' }
                    }},
                    pillars: { label: 'Key Pillars', type: 'array', itemLabel: 'Pillar', fields: {
                        title: { type: 'text', label: 'Title' },
                        desc: { type: 'textarea', label: 'Description' }
                    }},
                    practices: { label: 'Practices', type: 'array', itemLabel: 'Practice', fields: {
                        title: { type: 'text', label: 'Title' },
                        desc: { type: 'textarea', label: 'Description' }
                    }},
                    metrics: { label: 'Sustainability Metrics', type: 'array', itemLabel: 'Metric', fields: {
                        icon: { type: 'text', label: 'Icon (e.g. fa-leaf)' },
                        value: { type: 'text', label: 'Value' },
                        label: { type: 'text', label: 'Label' }
                    }}
                }
            },
            contact: {
                label: 'Contact', icon: 'fa-envelope',
                sections: {
                    hero: { label: 'Hero', fields: {
                        label: { type: 'text', label: 'Page Label' },
                        title: { type: 'text', label: 'Page Title' }
                    }},
                    enquiry: { label: 'Project Enquiry', fields: {
                        label: { type: 'text', label: 'Section Label' },
                        heading: { type: 'textarea', label: 'Heading Text' },
                        email: { type: 'text', label: 'Email' },
                        linkedin: { type: 'text', label: 'LinkedIn Profile Name' }
                    }},
                    offices: { label: 'Offices', fields: {
                        label: { type: 'text', label: 'Section Label' },
                        locations: { type: 'array', itemLabel: 'Office', fields: {
                            country: { type: 'text', label: 'Country' },
                            city: { type: 'text', label: 'City' },
                            type: { type: 'text', label: 'Office Type' },
                            address: { type: 'text', label: 'Address' }
                        }}
                    }},
                    regions: { label: 'Regions Served', fields: {
                        label: { type: 'text', label: 'Section Label' },
                        desc: { type: 'textarea', label: 'Description' },
                        items: { type: 'stringArray', label: 'Regions List' }
                    }},
                    media: { label: 'Media Relations', fields: {
                        label: { type: 'text', label: 'Section Label' },
                        desc: { type: 'textarea', label: 'Description' },
                        email: { type: 'text', label: 'Media Email' }
                    }},
                    phone: { label: 'Phone Number', fields: {
                        _self: { type: 'text', label: 'Phone Number' }
                    }},
                    responseGuarantee: { label: 'Response Guarantee', fields: {
                        title: { type: 'text', label: 'Title' },
                        desc: { type: 'textarea', label: 'Description' }
                    }},
                    faq: { label: 'FAQ', type: 'array', itemLabel: 'FAQ Item', fields: {
                        question: { type: 'text', label: 'Question' },
                        answer: { type: 'textarea', label: 'Answer' }
                    }}
                }
            },
            shared: {
                label: 'Shared / Global', icon: 'fa-globe',
                sections: {
                    phone: { label: 'Phone Number', fields: {
                        _self: { type: 'text', label: 'Phone Number' }
                    }},
                    socialLinks: { label: 'Social Media Links', fields: {
                        linkedin: { type: 'text', label: 'LinkedIn URL' },
                        twitter: { type: 'text', label: 'Twitter/X URL' },
                        youtube: { type: 'text', label: 'YouTube URL' }
                    }}
                }
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initNavigation();
            renderDashboard();
            renderAllSections();
            initContentEditor().then(() => {
                loadSettingsFields();
                renderVisibilityEditor();
            });
            renderNavigationEditor();
            loadTheme();
        });

        // Theme
        function toggleTheme() {
            const theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
            document.body.dataset.theme = theme;
            localStorage.setItem('adminTheme', theme);
            document.getElementById('theme-icon').className = theme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
        }

        function loadTheme() {
            const theme = localStorage.getItem('adminTheme') || 'dark';
            document.body.dataset.theme = theme;
            document.getElementById('theme-icon').className = theme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
        }

        // Navigation
        function initNavigation() {
            document.querySelectorAll('.sidebar-nav a').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    showSection(link.dataset.section);
                });
            });
        }

        function showSection(section) {
            document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
            document.querySelector(`[data-section="${section}"]`)?.classList.add('active');
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(section)?.classList.add('active');
            currentSection = section;
        }

        // ===== VISIBILITY TOGGLES =====
        const VISIBILITY_MAP = {
            home: { label: 'Home', icon: 'fa-home', sections: { hero: 'Hero Banner', stats: 'Key Statistics', clientLogos: 'Client Logos', about: 'About Preview', capabilities: 'Capabilities Cards', projects: 'Featured Projects', process: 'How We Work', testimonials: 'Testimonials', trustStrip: 'Trust Strip', closing: 'Closing CTA' }},
            about: { label: 'About', icon: 'fa-building', sections: { hero: 'Hero', company: 'Company Story', timeline: 'Timeline', leadership: 'Leadership Team', certifications: 'Certifications', partners: 'Partners', culture: 'Culture & Values', careers: 'Careers CTA' }},
            capabilities: { label: 'Capabilities', icon: 'fa-th-large', sections: { hero: 'Hero', overview: 'Overview', differentiators: 'Differentiators', sectors: 'Sectors Grid', methodology: 'Methodology', cta: 'Contact CTA' }},
            marine: { label: 'Marine', icon: 'fa-water', sections: { hero: 'Hero', sectorStats: 'Sector Stats', intro: 'Introduction', services: 'Services', featuredProject: 'Featured Project', whyChooseUs: 'Why Choose Us', cta: 'Contact CTA' }},
            transport: { label: 'Transport', icon: 'fa-road', sections: { hero: 'Hero', sectorStats: 'Sector Stats', intro: 'Introduction', services: 'Services', featuredProject: 'Featured Project', whyChooseUs: 'Why Choose Us', cta: 'Contact CTA' }},
            energy: { label: 'Energy', icon: 'fa-bolt', sections: { hero: 'Hero', sectorStats: 'Sector Stats', intro: 'Introduction', services: 'Services', featuredProject: 'Featured Project', whyChooseUs: 'Why Choose Us', cta: 'Contact CTA' }},
            systems: { label: 'Systems', icon: 'fa-cubes', sections: { hero: 'Hero', sectorStats: 'Sector Stats', intro: 'Introduction', technologies: 'Technologies', benefits: 'Benefits', featuredProject: 'Featured Project', whyChooseUs: 'Why Choose Us', cta: 'Contact CTA' }},
            sustainability: { label: 'Sustainability', icon: 'fa-leaf', sections: { hero: 'Hero', plan: 'Commitment', metrics: 'Metrics', pillars: 'Pillars', practices: 'Practices', cta: 'Contact CTA' }},
            contact: { label: 'Contact', icon: 'fa-envelope', sections: { hero: 'Hero', form: 'Contact Form & Sidebar', faq: 'FAQ Section' }},
            careers: { label: 'Careers', icon: 'fa-briefcase', sections: { hero: 'Hero', intro: 'Introduction', categories: 'Job Categories', whyJoin: 'Why Join Us', eoiForm: 'EOI Form', contact: 'Contact Section' }}
        };

        function getVisibility() {
            if (!contentWorkingCopy) return {};
            if (!contentWorkingCopy.sectionVisibility) {
                contentWorkingCopy.sectionVisibility = {};
                for (const [page, cfg] of Object.entries(VISIBILITY_MAP)) {
                    contentWorkingCopy.sectionVisibility[page] = {};
                    for (const key of Object.keys(cfg.sections)) {
                        contentWorkingCopy.sectionVisibility[page][key] = true;
                    }
                }
            }
            return contentWorkingCopy.sectionVisibility;
        }

        function renderVisibilityEditor() {
            const container = document.getElementById('visibility-editor');
            if (!container) return;
            const vis = getVisibility();
            let html = '';
            for (const [pageKey, pageCfg] of Object.entries(VISIBILITY_MAP)) {
                const pageVis = vis[pageKey] || {};
                html += `<div class="item-card card-wide mt-20"><div class="item-card-content">
                    <h3 class="card-title-accent"><i class="fas ${pageCfg.icon}"></i> ${pageCfg.label}</h3>`;
                for (const [secKey, secLabel] of Object.entries(pageCfg.sections)) {
                    const checked = pageVis[secKey] !== false ? 'checked' : '';
                    html += `<div class="visibility-row">
                        <span class="visibility-label">${secLabel}</span>
                        <label class="toggle-switch">
                            <input type="checkbox" ${checked} onchange="toggleVisibility('${pageKey}','${secKey}', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>`;
                }
                html += `</div></div>`;
            }
            container.innerHTML = html;
        }

        function toggleVisibility(page, section, checked) {
            const vis = getVisibility();
            if (!vis[page]) vis[page] = {};
            vis[page][section] = checked;
            pendingChanges.add('content');
            localStorage.setItem('siteContent', JSON.stringify(contentWorkingCopy));
        }

        function saveVisibility() {
            saveAllContent();
            showToast('Visibility settings saved!', 'success');
        }

        function resetVisibility() {
            const vis = getVisibility();
            for (const [page, cfg] of Object.entries(VISIBILITY_MAP)) {
                if (!vis[page]) vis[page] = {};
                for (const key of Object.keys(cfg.sections)) {
                    vis[page][key] = true;
                }
            }
            pendingChanges.add('content');
            renderVisibilityEditor();
            showToast('All sections set to visible', 'info');
        }

        // Dashboard
        function renderDashboard() {
            const projectsCount = contentWorkingCopy && contentWorkingCopy.home && contentWorkingCopy.home.projects ? contentWorkingCopy.home.projects.length : 0;
            const testimonialsCount = contentWorkingCopy && contentWorkingCopy.home && contentWorkingCopy.home.testimonials ? contentWorkingCopy.home.testimonials.length : 0;
            const stats = [
                { icon: 'fa-users', value: (window.TEAM_DATA || []).length, label: 'Team Members' },
                { icon: 'fa-layer-group', value: (window.SERVICES_DATA || []).length, label: 'Service Areas' },
                { icon: 'fa-map-marker-alt', value: (window.LOCATIONS_DATA || []).length, label: 'Locations' },
                { icon: 'fa-project-diagram', value: projectsCount, label: 'Projects' },
                { icon: 'fa-quote-right', value: testimonialsCount, label: 'Testimonials' }
            ];

            document.getElementById('stats-grid').innerHTML = stats.map(s => `
                <div class="stat-card">
                    <i class="fas ${s.icon}"></i>
                    <div class="value">${s.value}</div>
                    <div class="label">${s.label}</div>
                </div>
            `).join('');
        }

        // Render All
        function renderAllSections() {
            renderTeam();
            renderServices();
            renderLocations();
            renderProjects();
            renderTestimonials();
        }

        // Get Data
        function getDataArray(type) {
            switch(type) {
                case 'team': return window.TEAM_DATA || [];
                case 'services': return window.SERVICES_DATA || [];
                case 'locations': return window.LOCATIONS_DATA || [];
                case 'projects':
                    if (!contentWorkingCopy) contentWorkingCopy = {};
                    if (!contentWorkingCopy.home) contentWorkingCopy.home = {};
                    if (!contentWorkingCopy.home.projects) contentWorkingCopy.home.projects = [];
                    return contentWorkingCopy.home.projects;
                case 'testimonials':
                    if (!contentWorkingCopy) contentWorkingCopy = {};
                    if (!contentWorkingCopy.home) contentWorkingCopy.home = {};
                    if (!contentWorkingCopy.home.testimonials) contentWorkingCopy.home.testimonials = [];
                    return contentWorkingCopy.home.testimonials;
                default: return [];
            }
        }

        // Render Team
        function renderTeam() {
            const data = window.TEAM_DATA || [];
            const grid = document.getElementById('team-grid');
            if (!grid) return;

            grid.innerHTML = data.map((item, i) => `
                <div class="item-card">
                    <div class="item-card-content">
                        <div class="item-card-header">
                            <h3>${escapeHTML(item.name)}</h3>
                            <span class="category">${escapeHTML(item.role)}</span>
                        </div>
                        <p>${escapeHTML(item.desc || '').substring(0, 100)}...</p>
                        <div class="item-card-actions">
                            <button class="btn btn-secondary btn-icon" onclick="editItem('team', ${i})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-icon" onclick="deleteItem('team', ${i})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('') || '<p style="color:var(--text-muted)">No team members yet.</p>';
        }

        // Render Services
        function renderServices() {
            const data = window.SERVICES_DATA || [];
            const grid = document.getElementById('services-grid');
            if (!grid) return;

            grid.innerHTML = data.map((item, i) => `
                <div class="item-card">
                    <div class="item-card-content">
                        <div class="item-card-header">
                            <h3>${escapeHTML(item.title)}</h3>
                            <span class="category">${escapeHTML(item.category)}</span>
                        </div>
                        <p>${escapeHTML(item.description || '').substring(0, 100)}...</p>
                        <div class="item-card-actions">
                            <button class="btn btn-secondary btn-icon" onclick="editItem('services', ${i})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-icon" onclick="deleteItem('services', ${i})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('') || '<p style="color:var(--text-muted)">No services yet.</p>';
        }

        // Render Locations
        function renderLocations() {
            const data = window.LOCATIONS_DATA || [];
            const grid = document.getElementById('locations-grid');
            if (!grid) return;

            grid.innerHTML = data.map((item, i) => `
                <div class="item-card">
                    <div class="item-card-content">
                        <div class="item-card-header">
                            <h3>${escapeHTML(item.city)}, ${escapeHTML(item.country)}</h3>
                            <span class="category">${escapeHTML(item.type)}</span>
                        </div>
                        <p>${escapeHTML(item.address || '')}</p>
                        <div class="item-card-actions">
                            <button class="btn btn-secondary btn-icon" onclick="editItem('locations', ${i})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-icon" onclick="deleteItem('locations', ${i})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('') || '<p style="color:var(--text-muted)">No locations yet.</p>';
        }

        // Render Projects
        function renderProjects() {
            const data = getDataArray('projects');
            const grid = document.getElementById('projects-grid');
            if (!grid) return;

            grid.innerHTML = data.map((item, i) => `
                <div class="item-card">
                    <div class="item-card-content">
                        <div class="item-card-header">
                            <h3>${escapeHTML(item.title || '')}</h3>
                            <span class="category">${escapeHTML(item.sector || '')}</span>
                        </div>
                        <p>${escapeHTML(item.location || '')} &mdash; ${escapeHTML((item.desc || '').substring(0, 100))}...</p>
                        <div class="item-card-actions">
                            <button class="btn btn-secondary btn-icon" onclick="editItem('projects', ${i})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-icon" onclick="deleteItem('projects', ${i})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('') || '<p style="color:var(--text-muted)">No projects yet.</p>';
        }

        // Render Testimonials
        function renderTestimonials() {
            const data = getDataArray('testimonials');
            const grid = document.getElementById('testimonials-grid');
            if (!grid) return;

            grid.innerHTML = data.map((item, i) => `
                <div class="item-card">
                    <div class="item-card-content">
                        <div class="item-card-header">
                            <h3>${escapeHTML(item.name || '')}</h3>
                            <span class="category">${escapeHTML(item.role || '')}${item.company ? ', ' + escapeHTML(item.company) : ''}</span>
                        </div>
                        <p>"${escapeHTML((item.quote || '').substring(0, 120))}..."</p>
                        <div class="item-card-actions">
                            <button class="btn btn-secondary btn-icon" onclick="editItem('testimonials', ${i})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-icon" onclick="deleteItem('testimonials', ${i})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('') || '<p style="color:var(--text-muted)">No testimonials yet.</p>';
        }

        // Modal Functions
        function getItemLabel(type) {
            const labels = { team: 'Team Member', services: 'Service', locations: 'Location', projects: 'Project', testimonials: 'Testimonial' };
            return labels[type] || capitalize(type);
        }

        function openAddModal(type) {
            currentEditType = type;
            currentEditIndex = null;
            document.getElementById('modal-title').textContent = `Add ${getItemLabel(type)}`;
            document.getElementById('modal-body').innerHTML = getFormHTML(type, {});
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function editItem(type, index) {
            currentEditType = type;
            currentEditIndex = index;
            const data = getDataArray(type)[index];
            document.getElementById('modal-title').textContent = `Edit ${getItemLabel(type)}`;
            document.getElementById('modal-body').innerHTML = getFormHTML(type, data);
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            currentEditType = null;
            currentEditIndex = null;
        }

        function getFormHTML(type, data) {
            if (type === 'team') {
                return `
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" class="form-control" id="form-name" value="${escapeHTML(data.name || '')}">
                    </div>
                    <div class="form-group">
                        <label>Role / Title</label>
                        <input type="text" class="form-control" id="form-role" value="${escapeHTML(data.role || '')}">
                    </div>
                    <div class="form-group">
                        <label>Bio <button type="button" class="ai-gen-btn" onclick="aiGenerateBio()"><i class="fas fa-robot"></i> Generate</button></label>
                        <textarea class="form-control" id="form-bio">${escapeHTML(data.desc || '')}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Photo</label>
                        <div class="photo-upload-area">
                            <div class="photo-preview" id="photo-preview">
                                ${data.photo ? `<img src="${data.photo}" alt="Preview">` : '<i class="fas fa-user"></i>'}
                            </div>
                            <div class="photo-controls">
                                <input type="file" id="form-photo-file" accept="image/*" onchange="handlePhotoUpload(this)" style="display:none;">
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('form-photo-file').click()">
                                    <i class="fas fa-upload"></i> Upload Photo
                                </button>
                                <input type="text" class="form-control" id="form-photo" value="${escapeHTML(data.photo || '')}" placeholder="Or enter URL/path">
                            </div>
                        </div>
                    </div>
                `;
            }
            if (type === 'services') {
                return `
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" class="form-control" id="form-title" value="${escapeHTML(data.title || '')}">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <input type="text" class="form-control" id="form-category" value="${escapeHTML(data.category || '')}">
                    </div>
                    <div class="form-group">
                        <label>Description <button type="button" class="ai-gen-btn" onclick="aiGenerateDescription()"><i class="fas fa-robot"></i> Generate</button></label>
                        <textarea class="form-control" id="form-description">${escapeHTML(data.description || '')}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Link</label>
                        <input type="text" class="form-control" id="form-link" value="${escapeHTML(data.link || '')}" placeholder="/marine">
                    </div>
                `;
            }
            if (type === 'locations') {
                return `
                    <div class="form-group">
                        <label>Country</label>
                        <input type="text" class="form-control" id="form-country" value="${escapeHTML(data.country || '')}">
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" class="form-control" id="form-city" value="${escapeHTML(data.city || '')}">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <input type="text" class="form-control" id="form-type" value="${escapeHTML(data.type || '')}" placeholder="Headquarters, Office, etc.">
                    </div>
                    <div class="form-group">
                        <label>Full Address</label>
                        <textarea class="form-control" id="form-address">${escapeHTML(data.address || '')}</textarea>
                    </div>
                `;
            }
            if (type === 'projects') {
                return `
                    <div class="form-group">
                        <label>Project Title</label>
                        <input type="text" class="form-control" id="form-title" value="${escapeHTML(data.title || '')}">
                    </div>
                    <div class="form-group">
                        <label>Sector</label>
                        <select class="form-control" id="form-sector">
                            <option value="marine" ${data.sector === 'marine' ? 'selected' : ''}>Marine</option>
                            <option value="transport" ${data.sector === 'transport' ? 'selected' : ''}>Transport</option>
                            <option value="energy" ${data.sector === 'energy' ? 'selected' : ''}>Energy</option>
                            <option value="systems" ${data.sector === 'systems' ? 'selected' : ''}>Construction Systems</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" class="form-control" id="form-location" value="${escapeHTML(data.location || '')}">
                    </div>
                    <div class="form-group">
                        <label>Description <button type="button" class="ai-gen-btn" onclick="aiGenerateDescription()"><i class="fas fa-robot"></i> Generate</button></label>
                        <textarea class="form-control" id="form-description">${escapeHTML(data.desc || '')}</textarea>
                    </div>
                `;
            }
            if (type === 'testimonials') {
                return `
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" class="form-control" id="form-name" value="${escapeHTML(data.name || '')}">
                    </div>
                    <div class="form-group">
                        <label>Role / Position</label>
                        <input type="text" class="form-control" id="form-role" value="${escapeHTML(data.role || '')}">
                    </div>
                    <div class="form-group">
                        <label>Company</label>
                        <input type="text" class="form-control" id="form-company" value="${escapeHTML(data.company || '')}">
                    </div>
                    <div class="form-group">
                        <label>Quote / Testimonial</label>
                        <textarea class="form-control" id="form-quote">${escapeHTML(data.quote || '')}</textarea>
                    </div>
                `;
            }
            return '';
        }

        function saveItem() {
            const data = getDataArray(currentEditType);
            let item = {};

            if (currentEditType === 'team') {
                item = {
                    id: document.getElementById('form-name').value.toLowerCase().replace(/\s+/g, '-'),
                    name: document.getElementById('form-name').value,
                    role: document.getElementById('form-role').value,
                    desc: document.getElementById('form-bio').value,
                    photo: document.getElementById('form-photo').value,
                    order: currentEditIndex !== null ? data[currentEditIndex].order : data.length + 1
                };
            } else if (currentEditType === 'services') {
                item = {
                    id: document.getElementById('form-title').value.toLowerCase().replace(/\s+/g, '-'),
                    title: document.getElementById('form-title').value,
                    category: document.getElementById('form-category').value,
                    description: document.getElementById('form-description').value,
                    link: document.getElementById('form-link').value,
                    services: currentEditIndex !== null ? data[currentEditIndex].services : []
                };
            } else if (currentEditType === 'locations') {
                item = {
                    id: document.getElementById('form-city').value.toLowerCase().replace(/\s+/g, '-'),
                    country: document.getElementById('form-country').value,
                    city: document.getElementById('form-city').value,
                    type: document.getElementById('form-type').value,
                    address: document.getElementById('form-address').value
                };
            } else if (currentEditType === 'projects') {
                item = {
                    title: document.getElementById('form-title').value,
                    sector: document.getElementById('form-sector').value,
                    location: document.getElementById('form-location').value,
                    desc: document.getElementById('form-description').value,
                    stats: currentEditIndex !== null && data[currentEditIndex] ? data[currentEditIndex].stats || [] : []
                };
            } else if (currentEditType === 'testimonials') {
                item = {
                    quote: document.getElementById('form-quote').value,
                    name: document.getElementById('form-name').value,
                    role: document.getElementById('form-role').value,
                    company: document.getElementById('form-company').value
                };
            }

            if (currentEditIndex !== null) {
                data[currentEditIndex] = item;
            } else {
                data.push(item);
            }

            const changeType = (currentEditType === 'projects' || currentEditType === 'testimonials') ? 'content' : currentEditType;
            pendingChanges.add(changeType);
            closeModal();
            renderAllSections();
            renderDashboard();
            showToast('Item saved! Click Publish to save to GitHub.');
        }

        function deleteItem(type, index) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            const data = getDataArray(type);
            data.splice(index, 1);
            const changeType = (type === 'projects' || type === 'testimonials') ? 'content' : type;
            pendingChanges.add(changeType);
            renderAllSections();
            renderDashboard();
            showToast('Item deleted.');
        }

        // ===== SETTINGS =====
        function saveSettings() {
            const companyName = document.getElementById('company-name').value;
            const contactEmail = document.getElementById('contact-email').value;
            const careersEmail = document.getElementById('careers-email').value;
            const phone = document.getElementById('phone-number').value;
            const linkedin = document.getElementById('linkedin-url').value;
            const twitter = document.getElementById('twitter-url').value;
            const youtube = document.getElementById('youtube-url').value;

            // Update SETTINGS_DATA
            window.SETTINGS_DATA = window.SETTINGS_DATA || {};
            window.SETTINGS_DATA.companyName = companyName;
            window.SETTINGS_DATA.contactEmail = contactEmail;
            window.SETTINGS_DATA.careersEmail = careersEmail;
            window.SETTINGS_DATA.phone = phone;
            window.SETTINGS_DATA.linkedin = linkedin;
            window.SETTINGS_DATA.twitter = twitter;
            window.SETTINGS_DATA.youtube = youtube;
            pendingChanges.add('settings');

            // Also update shared content data
            if (contentWorkingCopy) {
                if (!contentWorkingCopy.shared) contentWorkingCopy.shared = {};
                contentWorkingCopy.shared.phone = phone;
                if (!contentWorkingCopy.shared.socialLinks) contentWorkingCopy.shared.socialLinks = {};
                contentWorkingCopy.shared.socialLinks.linkedin = linkedin;
                contentWorkingCopy.shared.socialLinks.twitter = twitter;
                contentWorkingCopy.shared.socialLinks.youtube = youtube;
                pendingChanges.add('content');
            }

            showToast('Settings saved! Click Publish to push to GitHub.', 'success');
        }

        function loadSettingsFields() {
            const settings = window.SETTINGS_DATA || {};
            if (settings.companyName) document.getElementById('company-name').value = settings.companyName;
            if (settings.contactEmail) document.getElementById('contact-email').value = settings.contactEmail;
            if (settings.careersEmail) document.getElementById('careers-email').value = settings.careersEmail;
            if (settings.phone) document.getElementById('phone-number').value = settings.phone;
            if (settings.linkedin) document.getElementById('linkedin-url').value = settings.linkedin;
            if (settings.twitter) document.getElementById('twitter-url').value = settings.twitter;
            if (settings.youtube) document.getElementById('youtube-url').value = settings.youtube;

            // Also try to load from shared content
            if (contentWorkingCopy && contentWorkingCopy.shared) {
                const shared = contentWorkingCopy.shared;
                if (shared.phone && !settings.phone) document.getElementById('phone-number').value = shared.phone;
                if (shared.socialLinks) {
                    if (shared.socialLinks.linkedin && !settings.linkedin) document.getElementById('linkedin-url').value = shared.socialLinks.linkedin;
                    if (shared.socialLinks.twitter && !settings.twitter) document.getElementById('twitter-url').value = shared.socialLinks.twitter;
                    if (shared.socialLinks.youtube && !settings.youtube) document.getElementById('youtube-url').value = shared.socialLinks.youtube;
                }
            }
        }

        // ===== CONTENT EDITOR =====
        // Deep merge: overlay saved edits on top of defaults so no fields are lost
        function deepMerge(base, overlay) {
            const result = Object.assign({}, base);
            for (const key of Object.keys(overlay)) {
                if (overlay[key] && typeof overlay[key] === 'object' && !Array.isArray(overlay[key])
                    && base[key] && typeof base[key] === 'object' && !Array.isArray(base[key])) {
                    result[key] = deepMerge(base[key], overlay[key]);
                } else {
                    result[key] = overlay[key];
                }
            }
            return result;
        }

        async function initContentEditor() {
            // Always load defaults first, then merge localStorage on top
            await loadDefaultContent();
            const saved = localStorage.getItem('siteContent');
            if (saved) {
                try {
                    const savedData = JSON.parse(saved);
                    contentWorkingCopy = deepMerge(contentWorkingCopy, savedData);
                } catch(e) { /* keep defaults */ }
            }
            renderContentPageTabs();
            renderContentEditor(currentContentPage);
        }

        async function loadDefaultContent() {
            try {
                const res = await fetch('web/content.js');
                const text = await res.text();
                const match = text.match(/export\s+const\s+defaultContent\s*=\s*(\{[\s\S]*\})\s*;/);
                if (match) {
                    contentWorkingCopy = new Function('return ' + match[1])();
                }
            } catch(e) {
                console.error('Failed to load default content:', e);
                contentWorkingCopy = {};
            }
        }

        function renderContentPageTabs() {
            const container = document.getElementById('content-page-tabs');
            if (!container) return;
            container.innerHTML = Object.entries(CONTENT_SCHEMA).map(([key, schema]) => `
                <button type="button" class="content-tab ${key === currentContentPage ? 'active' : ''}"
                    onclick="switchContentPage('${key}')">
                    <i class="fas ${schema.icon}"></i> ${schema.label}
                </button>
            `).join('');
        }

        function switchContentPage(pageKey) {
            currentContentPage = pageKey;
            renderContentPageTabs();
            renderContentEditor(pageKey);
        }

        function renderContentEditor(pageKey) {
            const area = document.getElementById('content-editor-area');
            if (!area || !contentWorkingCopy) return;
            const schema = CONTENT_SCHEMA[pageKey];
            if (!schema) { area.innerHTML = '<p class="text-muted">No schema defined.</p>'; return; }
            const pageData = contentWorkingCopy[pageKey] || {};
            let html = '';
            for (const [sectionKey, sectionSchema] of Object.entries(schema.sections)) {
                const sectionData = pageData[sectionKey];
                if (sectionSchema.type === 'stringArray') {
                    html += renderStringArraySection(pageKey, sectionKey, sectionSchema, sectionData || []);
                    continue;
                }
                html += `<div class="item-card card-wide mt-20"><div class="item-card-content">
                    <h3 class="card-title-accent"><i class="fas fa-layer-group"></i> ${sectionSchema.label}</h3>`;
                if (sectionSchema.type === 'array') {
                    html += renderArraySection(pageKey, sectionKey, sectionSchema, sectionData || []);
                } else if (sectionSchema.fields) {
                    for (const [fieldKey, fieldDef] of Object.entries(sectionSchema.fields)) {
                        if (fieldKey === '_self') {
                            // Bare value field (e.g. phone string)
                            const value = typeof sectionData === 'string' ? sectionData : (sectionData || '');
                            html += renderSimpleField(pageKey, sectionKey, fieldKey, fieldDef, value);
                        } else if (fieldDef.type === 'array') {
                            html += renderNestedArrayField(pageKey, sectionKey, fieldKey, fieldDef, sectionData ? sectionData[fieldKey] || [] : []);
                        } else if (fieldDef.type === 'stringArray') {
                            html += renderStringArrayField(pageKey, sectionKey, fieldKey, fieldDef, sectionData ? sectionData[fieldKey] || [] : []);
                        } else {
                            const value = sectionData ? (sectionData[fieldKey] || '') : '';
                            html += renderSimpleField(pageKey, sectionKey, fieldKey, fieldDef, value);
                        }
                    }
                }
                html += `</div></div>`;
            }
            area.innerHTML = html;
        }

        function renderSimpleField(page, section, field, def, value) {
            const id = `ce-${page}-${section}-${field}`;
            const ev = escapeHTML(value);
            const eligible = isAIEligibleField(def.label);
            const aiBtn = eligible ? ` <button type="button" class="ai-field-btn" onclick="aiEnhanceField('${id}','${escapeHTML(def.label)}','${page}','${section}')" title="${value ? 'Improve with AI' : 'Generate with AI'}"><i class="fas fa-wand-magic-sparkles"></i></button>` : '';
            if (def.type === 'textarea') {
                return `<div class="form-group"><label>${def.label}${aiBtn}</label>
                    <textarea class="form-control" id="${id}" onchange="updateContentField('${page}','${section}','${field}',this.value)">${ev}</textarea></div>`;
            }
            return `<div class="form-group"><label>${def.label}${aiBtn}</label>
                <input type="text" class="form-control" id="${id}" value="${ev}" onchange="updateContentField('${page}','${section}','${field}',this.value)"></div>`;
        }

        function renderArraySection(page, section, schema, items) {
            let html = `<div class="array-editor" id="ae-${page}-${section}">`;
            items.forEach((item, index) => {
                html += `<div class="array-item"><div class="array-item-header">
                    <span class="array-item-title">${schema.itemLabel} ${index + 1}: ${escapeHTML(item.title || item.name || '')}</span>
                    <div class="array-item-controls">
                        <button type="button" class="btn btn-secondary btn-icon btn-sm" onclick="moveArrayItem('${page}','${section}',${index},-1)" ${index === 0 ? 'disabled' : ''}><i class="fas fa-arrow-up"></i></button>
                        <button type="button" class="btn btn-secondary btn-icon btn-sm" onclick="moveArrayItem('${page}','${section}',${index},1)" ${index === items.length - 1 ? 'disabled' : ''}><i class="fas fa-arrow-down"></i></button>
                        <button type="button" class="btn btn-danger btn-icon btn-sm" onclick="removeArrayItem('${page}','${section}',${index})"><i class="fas fa-trash"></i></button>
                    </div></div><div class="array-item-fields">`;
                for (const [fk, fd] of Object.entries(schema.fields)) {
                    const val = item[fk] || '';
                    const fid = `ce-${page}-${section}-${index}-${fk}`;
                    const aiEligible = isAIEligibleField(fd.label);
                    const aiBtn = aiEligible ? ` <button type="button" class="ai-field-btn" onclick="aiEnhanceField('${fid}','${escapeHTML(fd.label)}','${page}','${section}')" title="AI"><i class="fas fa-wand-magic-sparkles"></i></button>` : '';
                    if (fd.type === 'textarea') {
                        html += `<div class="form-group"><label>${fd.label}${aiBtn}</label><textarea class="form-control" id="${fid}" onchange="updateArrayItemField('${page}','${section}',${index},'${fk}',this.value)">${escapeHTML(val)}</textarea></div>`;
                    } else {
                        html += `<div class="form-group"><label>${fd.label}${aiBtn}</label><input type="text" class="form-control" id="${fid}" value="${escapeHTML(val)}" onchange="updateArrayItemField('${page}','${section}',${index},'${fk}',this.value)"></div>`;
                    }
                }
                html += `</div></div>`;
            });
            html += `<button type="button" class="btn btn-primary mt-20" onclick="addArrayItem('${page}','${section}')"><i class="fas fa-plus"></i> Add ${schema.itemLabel}</button> <button type="button" class="btn btn-secondary mt-20" onclick="aiGenerateArrayItem('${page}','${section}')"><i class="fas fa-robot"></i> AI Generate ${schema.itemLabel}</button></div>`;
            return html;
        }

        function renderNestedArrayField(page, section, field, def, items) {
            let html = `<div class="form-group"><label style="font-weight:600;font-size:1rem;color:var(--accent)">${def.itemLabel}s</label></div>`;
            html += `<div class="array-editor" id="ae-${page}-${section}-${field}">`;
            items.forEach((item, index) => {
                html += `<div class="array-item"><div class="array-item-header">
                    <span class="array-item-title">${def.itemLabel} ${index + 1}: ${escapeHTML(item[Object.keys(def.fields)[0]] || '')}</span>
                    <div class="array-item-controls">
                        <button type="button" class="btn btn-secondary btn-icon btn-sm" onclick="moveNestedArrayItem('${page}','${section}','${field}',${index},-1)" ${index === 0 ? 'disabled' : ''}><i class="fas fa-arrow-up"></i></button>
                        <button type="button" class="btn btn-secondary btn-icon btn-sm" onclick="moveNestedArrayItem('${page}','${section}','${field}',${index},1)" ${index === items.length - 1 ? 'disabled' : ''}><i class="fas fa-arrow-down"></i></button>
                        <button type="button" class="btn btn-danger btn-icon btn-sm" onclick="removeNestedArrayItem('${page}','${section}','${field}',${index})"><i class="fas fa-trash"></i></button>
                    </div></div><div class="array-item-fields">`;
                for (const [fk, fd] of Object.entries(def.fields)) {
                    const val = item[fk] || '';
                    const fid = `ce-${page}-${section}-${field}-${index}-${fk}`;
                    const aiEligible = isAIEligibleField(fd.label);
                    const aiBtn = aiEligible ? ` <button type="button" class="ai-field-btn" onclick="aiEnhanceField('${fid}','${escapeHTML(fd.label)}','${page}','${section}')" title="AI"><i class="fas fa-wand-magic-sparkles"></i></button>` : '';
                    if (fd.type === 'textarea') {
                        html += `<div class="form-group"><label>${fd.label}${aiBtn}</label><textarea class="form-control" id="${fid}" onchange="updateNestedArrayItemField('${page}','${section}','${field}',${index},'${fk}',this.value)">${escapeHTML(val)}</textarea></div>`;
                    } else {
                        html += `<div class="form-group"><label>${fd.label}${aiBtn}</label><input type="text" class="form-control" id="${fid}" value="${escapeHTML(val)}" onchange="updateNestedArrayItemField('${page}','${section}','${field}',${index},'${fk}',this.value)"></div>`;
                    }
                }
                html += `</div></div>`;
            });
            html += `<button type="button" class="btn btn-primary mt-20" onclick="addNestedArrayItem('${page}','${section}','${field}')"><i class="fas fa-plus"></i> Add ${def.itemLabel}</button></div>`;
            return html;
        }

        function renderStringArrayField(page, section, field, def, items) {
            const id = `sa-${page}-${section}-${field}`;
            let html = `<div class="form-group"><label>${def.label}</label><div class="string-array-editor" id="${id}"><div class="tag-list">`;
            items.forEach((item, i) => {
                html += `<span class="tag">${escapeHTML(item)}<button type="button" class="tag-remove" onclick="removeStringArrayItem('${page}','${section}','${field}',${i})">&times;</button></span>`;
            });
            html += `</div><div class="tag-input-row"><input type="text" class="form-control" id="${id}-input" placeholder="Add item..." onkeypress="if(event.key==='Enter'){addStringArrayItem('${page}','${section}','${field}','${id}-input');event.preventDefault();}">
                <button type="button" class="btn btn-secondary" onclick="addStringArrayItem('${page}','${section}','${field}','${id}-input')"><i class="fas fa-plus"></i></button></div></div></div>`;
            return html;
        }

        function renderStringArraySection(page, section, schema, items) {
            let html = `<div class="item-card card-wide mt-20"><div class="item-card-content">
                <h3 class="card-title-accent"><i class="fas fa-list"></i> ${schema.label}</h3>`;
            html += renderStringArrayField(page, section, '_self', { label: schema.label }, items);
            html += `</div></div>`;
            return html;
        }

        // Content mutation functions
        function updateContentField(page, section, field, value) {
            if (!contentWorkingCopy[page]) contentWorkingCopy[page] = {};
            if (field === '_self') {
                // Bare value field (e.g. phone string)
                contentWorkingCopy[page][section] = value;
            } else {
                if (!contentWorkingCopy[page][section]) contentWorkingCopy[page][section] = {};
                contentWorkingCopy[page][section][field] = value;
            }
            pendingChanges.add('content');
        }

        function updateArrayItemField(page, section, index, field, value) {
            if (contentWorkingCopy[page] && contentWorkingCopy[page][section]) {
                contentWorkingCopy[page][section][index][field] = value;
                pendingChanges.add('content');
            }
        }

        function addArrayItem(page, section) {
            if (!contentWorkingCopy[page][section]) contentWorkingCopy[page][section] = [];
            const schema = CONTENT_SCHEMA[page].sections[section];
            const newItem = {};
            for (const key of Object.keys(schema.fields)) { newItem[key] = ''; }
            contentWorkingCopy[page][section].push(newItem);
            pendingChanges.add('content');
            renderContentEditor(currentContentPage);
        }

        function removeArrayItem(page, section, index) {
            if (!confirm('Remove this item?')) return;
            contentWorkingCopy[page][section].splice(index, 1);
            pendingChanges.add('content');
            renderContentEditor(currentContentPage);
        }

        function moveArrayItem(page, section, index, direction) {
            const arr = contentWorkingCopy[page][section];
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= arr.length) return;
            [arr[index], arr[newIndex]] = [arr[newIndex], arr[index]];
            pendingChanges.add('content');
            renderContentEditor(currentContentPage);
        }

        // Nested array mutations (e.g. contact.offices.locations)
        function updateNestedArrayItemField(page, section, field, index, fk, value) {
            if (contentWorkingCopy[page] && contentWorkingCopy[page][section] && contentWorkingCopy[page][section][field]) {
                contentWorkingCopy[page][section][field][index][fk] = value;
                pendingChanges.add('content');
            }
        }

        function addNestedArrayItem(page, section, field) {
            if (!contentWorkingCopy[page][section][field]) contentWorkingCopy[page][section][field] = [];
            const def = CONTENT_SCHEMA[page].sections[section].fields[field];
            const newItem = {};
            for (const key of Object.keys(def.fields)) { newItem[key] = ''; }
            contentWorkingCopy[page][section][field].push(newItem);
            pendingChanges.add('content');
            renderContentEditor(currentContentPage);
        }

        function removeNestedArrayItem(page, section, field, index) {
            if (!confirm('Remove this item?')) return;
            contentWorkingCopy[page][section][field].splice(index, 1);
            pendingChanges.add('content');
            renderContentEditor(currentContentPage);
        }

        function moveNestedArrayItem(page, section, field, index, direction) {
            const arr = contentWorkingCopy[page][section][field];
            const ni = index + direction;
            if (ni < 0 || ni >= arr.length) return;
            [arr[index], arr[ni]] = [arr[ni], arr[index]];
            pendingChanges.add('content');
            renderContentEditor(currentContentPage);
        }

        // String array mutations
        function addStringArrayItem(page, section, field, inputId) {
            const input = document.getElementById(inputId);
            const value = input.value.trim();
            if (!value) return;
            if (field === '_self') {
                if (!contentWorkingCopy[page][section]) contentWorkingCopy[page][section] = [];
                contentWorkingCopy[page][section].push(value);
            } else {
                if (!contentWorkingCopy[page][section][field]) contentWorkingCopy[page][section][field] = [];
                contentWorkingCopy[page][section][field].push(value);
            }
            input.value = '';
            pendingChanges.add('content');
            renderContentEditor(currentContentPage);
        }

        function removeStringArrayItem(page, section, field, index) {
            if (field === '_self') {
                contentWorkingCopy[page][section].splice(index, 1);
            } else {
                contentWorkingCopy[page][section][field].splice(index, 1);
            }
            pendingChanges.add('content');
            renderContentEditor(currentContentPage);
        }

        // Content save/preview/reset
        function saveAllContent() {
            localStorage.setItem('siteContent', JSON.stringify(contentWorkingCopy));
            pendingChanges.add('content');
            showToast('Content saved locally! Click Publish to push to GitHub.', 'success');
        }

        function previewContent() {
            localStorage.setItem('siteContent', JSON.stringify(contentWorkingCopy));
            window.open('index.html', '_blank');
            showToast('Content saved for preview. Opening site...', 'info');
        }

        function resetContentToDefaults() {
            if (!confirm('Reset all content to defaults? This cannot be undone.')) return;
            localStorage.removeItem('siteContent');
            contentWorkingCopy = null;
            loadDefaultContent().then(() => {
                renderContentEditor(currentContentPage);
                showToast('Content reset to defaults.', 'info');
            });
        }

        // ===== NAVIGATION EDITOR =====
        function renderNavigationEditor() {
            const navData = window.NAV_DATA || { megaMenus: [], standaloneLinks: [] };
            const megaContainer = document.getElementById('nav-mega-menus');
            if (megaContainer) {
                megaContainer.innerHTML = navData.megaMenus.map((menu, mi) => `
                    <div class="item-card card-wide mt-20"><div class="item-card-content">
                        <div class="array-item-header">
                            <h3 class="card-title-accent"><i class="fas fa-th"></i> Mega Menu: ${escapeHTML(menu.label)}</h3>
                            <div class="array-item-controls">
                                <button type="button" class="btn btn-danger btn-icon btn-sm" onclick="removeMegaMenu(${mi})"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="form-group"><label>Menu Label</label>
                            <input type="text" class="form-control" value="${escapeHTML(menu.label)}" onchange="updateMegaMenu(${mi},'label',this.value)"></div>
                        <div class="form-group"><label>Link Href</label>
                            <input type="text" class="form-control" value="${escapeHTML(menu.href)}" onchange="updateMegaMenu(${mi},'href',this.value)"></div>
                        <h4 class="mt-20">Columns</h4>
                        ${menu.columns.map((col, ci) => renderNavColumn(mi, ci, col)).join('')}
                        <button type="button" class="btn btn-secondary mt-20" onclick="addNavColumn(${mi})"><i class="fas fa-plus"></i> Add Column</button>
                    </div></div>
                `).join('') + `<button type="button" class="btn btn-primary mt-20" onclick="addMegaMenu()"><i class="fas fa-plus"></i> Add Mega Menu</button>`;
            }
            const standaloneContainer = document.getElementById('nav-standalone-links');
            if (standaloneContainer) {
                standaloneContainer.innerHTML = navData.standaloneLinks.map((link, li) => `
                    <div class="item-card mt-20" style="max-width:500px"><div class="item-card-content">
                        <div class="array-item-header">
                            <span>${escapeHTML(link.label)}</span>
                            <div class="array-item-controls">
                                <button type="button" class="btn btn-danger btn-icon btn-sm" onclick="removeStandaloneLink(${li})"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="form-group"><label>Label</label>
                            <input type="text" class="form-control" value="${escapeHTML(link.label)}" onchange="updateStandaloneLink(${li},'label',this.value)"></div>
                        <div class="form-group"><label>Href</label>
                            <input type="text" class="form-control" value="${escapeHTML(link.href)}" onchange="updateStandaloneLink(${li},'href',this.value)"></div>
                    </div></div>
                `).join('');
            }
        }

        function renderNavColumn(mi, ci, col) {
            let linksHtml = '';
            if (col.type === 'text') {
                linksHtml = `<div class="form-group"><label>Text Content</label>
                    <input type="text" class="form-control" value="${escapeHTML(col.text || '')}" onchange="updateNavColumn(${mi},${ci},'text',this.value)"></div>`;
            } else {
                linksHtml = (col.links || []).map((link, li) => `
                    <div class="nav-link-row">
                        <input type="text" class="form-control" value="${escapeHTML(link.text)}" placeholder="Link text" onchange="updateNavLink(${mi},${ci},${li},'text',this.value)">
                        <input type="text" class="form-control" value="${escapeHTML(link.href)}" placeholder="#hash" onchange="updateNavLink(${mi},${ci},${li},'href',this.value)">
                        <button type="button" class="btn btn-danger btn-icon btn-sm" onclick="removeNavLink(${mi},${ci},${li})"><i class="fas fa-trash"></i></button>
                    </div>`).join('');
                linksHtml += `<button type="button" class="btn btn-secondary btn-sm mt-20" onclick="addNavLink(${mi},${ci})"><i class="fas fa-plus"></i> Add Link</button>`;
            }
            return `<div class="nav-column-editor">
                <div class="array-item-header">
                    <strong>Column ${ci + 1}</strong>
                    <div class="array-item-controls">
                        <select class="form-control" style="width:auto;display:inline" onchange="updateNavColumnType(${mi},${ci},this.value)">
                            <option value="links" ${col.type !== 'text' ? 'selected' : ''}>Links</option>
                            <option value="text" ${col.type === 'text' ? 'selected' : ''}>Text</option>
                        </select>
                        <button type="button" class="btn btn-danger btn-icon btn-sm" onclick="removeNavColumn(${mi},${ci})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="form-group"><label>Column Heading</label>
                    <input type="text" class="form-control" value="${escapeHTML(col.heading)}" onchange="updateNavColumn(${mi},${ci},'heading',this.value)"></div>
                ${linksHtml}
            </div>`;
        }

        // Navigation mutations
        function updateMegaMenu(mi, field, value) {
            window.NAV_DATA.megaMenus[mi][field] = value;
            pendingChanges.add('navigation');
        }

        function addMegaMenu() {
            window.NAV_DATA.megaMenus.push({ id: 'menu-' + Date.now(), label: 'New Menu', href: '#', columns: [] });
            pendingChanges.add('navigation');
            renderNavigationEditor();
        }

        function removeMegaMenu(mi) {
            if (!confirm('Remove this mega menu?')) return;
            window.NAV_DATA.megaMenus.splice(mi, 1);
            pendingChanges.add('navigation');
            renderNavigationEditor();
        }

        function addNavColumn(mi) {
            window.NAV_DATA.megaMenus[mi].columns.push({ heading: 'New Column', links: [] });
            pendingChanges.add('navigation');
            renderNavigationEditor();
        }

        function removeNavColumn(mi, ci) {
            window.NAV_DATA.megaMenus[mi].columns.splice(ci, 1);
            pendingChanges.add('navigation');
            renderNavigationEditor();
        }

        function updateNavColumn(mi, ci, field, value) {
            window.NAV_DATA.megaMenus[mi].columns[ci][field] = value;
            pendingChanges.add('navigation');
        }

        function updateNavColumnType(mi, ci, type) {
            const col = window.NAV_DATA.megaMenus[mi].columns[ci];
            if (type === 'text') {
                col.type = 'text';
                col.text = col.text || '';
                delete col.links;
            } else {
                delete col.type;
                delete col.text;
                col.links = col.links || [];
            }
            pendingChanges.add('navigation');
            renderNavigationEditor();
        }

        function updateNavLink(mi, ci, li, field, value) {
            window.NAV_DATA.megaMenus[mi].columns[ci].links[li][field] = value;
            pendingChanges.add('navigation');
        }

        function addNavLink(mi, ci) {
            window.NAV_DATA.megaMenus[mi].columns[ci].links.push({ text: 'New Link', href: '#' });
            pendingChanges.add('navigation');
            renderNavigationEditor();
        }

        function removeNavLink(mi, ci, li) {
            window.NAV_DATA.megaMenus[mi].columns[ci].links.splice(li, 1);
            pendingChanges.add('navigation');
            renderNavigationEditor();
        }

        function updateStandaloneLink(li, field, value) {
            window.NAV_DATA.standaloneLinks[li][field] = value;
            pendingChanges.add('navigation');
        }

        function addStandaloneLink() {
            window.NAV_DATA.standaloneLinks.push({ label: 'New Link', href: '#' });
            pendingChanges.add('navigation');
            renderNavigationEditor();
        }

        function removeStandaloneLink(li) {
            window.NAV_DATA.standaloneLinks.splice(li, 1);
            pendingChanges.add('navigation');
            renderNavigationEditor();
        }

        function saveNavigation() {
            pendingChanges.add('navigation');
            showToast('Navigation changes saved. Click Publish to push to GitHub.', 'success');
        }

        // GitHub Functions
        function openGitHubConfig() {
            document.getElementById('github-owner').value = gitHubConfig.owner || 'EnochMacwan';
            document.getElementById('github-repo').value = gitHubConfig.repo || 'sapthavarna-web';
            document.getElementById('github-branch').value = gitHubConfig.branch || 'master';
            document.getElementById('github-token').value = gitHubConfig.token || '';
            document.getElementById('github-status').innerHTML = '';
            document.getElementById('github-config-overlay').style.display = 'flex';
        }

        function closeGitHubConfig() {
            document.getElementById('github-config-overlay').style.display = 'none';
        }

        function saveGitHubConfig() {
            gitHubConfig = {
                owner: document.getElementById('github-owner').value.trim(),
                repo: document.getElementById('github-repo').value.trim(),
                branch: document.getElementById('github-branch').value.trim(),
                token: document.getElementById('github-token').value.trim()
            };
            localStorage.setItem('svgt_github_config', JSON.stringify(gitHubConfig));
            closeGitHubConfig();
            showToast('GitHub settings saved!', 'success');
        }

        async function testGitHubConnection() {
            const owner = document.getElementById('github-owner').value.trim();
            const repo = document.getElementById('github-repo').value.trim();
            const token = document.getElementById('github-token').value.trim();
            const status = document.getElementById('github-status');

            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            status.style.color = 'var(--text)';

            try {
                const res = await fetch(`https://api.github.com/repos/${owner}/${repo}`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                if (res.ok) {
                    status.innerHTML = '<i class="fas fa-check-circle"></i> Connected!';
                    status.style.color = 'var(--success)';
                } else {
                    status.innerHTML = '<i class="fas fa-times-circle"></i> Connection failed';
                    status.style.color = 'var(--danger)';
                }
            } catch(e) {
                status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error: ' + e.message;
                status.style.color = 'var(--danger)';
            }
        }

        async function loadDataFromGitHub() {
            if (!gitHubConfig.token) {
                showToast('Configure GitHub first', 'error');
                return;
            }
            showToast('Loading from GitHub...', 'info');

            for (const type of Object.keys(GITHUB_DATA_FILES)) {
                try {
                    const res = await fetch(
                        `https://raw.githubusercontent.com/${gitHubConfig.owner}/${gitHubConfig.repo}/${gitHubConfig.branch}/${GITHUB_DATA_FILES[type]}?t=${Date.now()}`
                    );
                    if (res.ok) {
                        const content = await res.text();
                        let data = null;
                        if (type === 'content') {
                            const match = content.match(/export\s+const\s+defaultContent\s*=\s*(\{[\s\S]*\})\s*;/);
                            if (match) data = new Function('return ' + match[1])();
                        } else {
                            const match = content.match(/(?:var\s+\w+|const\s+\w+|let\s+\w+|window\.\w+)\s*=\s*(\{[\s\S]*?\}|\[[\s\S]*?\])\s*;/);
                            if (match) data = new Function('return ' + match[1])();
                        }
                        if (data) {
                            window[GITHUB_VAR_NAMES[type]] = data;
                            if (type === 'content') contentWorkingCopy = data;
                        }
                    }
                } catch(e) {
                    console.log(`Could not load ${type}:`, e);
                }
            }

            renderDashboard();
            renderAllSections();
            renderContentEditor(currentContentPage);
            renderNavigationEditor();
            loadSettingsFields();
            showToast('Data loaded from GitHub!', 'success');
        }

        async function publishAllChanges() {
            if (!gitHubConfig.token) {
                showToast('Configure GitHub first', 'error');
                return;
            }

            if (pendingChanges.size === 0) {
                showToast('No changes to publish', 'info');
                return;
            }

            showToast('Publishing to GitHub...', 'info');

            for (const type of pendingChanges) {
                let data;
                if (type === 'content') {
                    data = contentWorkingCopy;
                } else if (type === 'navigation') {
                    data = window.NAV_DATA;
                } else {
                    data = getDataArray(type);
                }
                await saveToGitHub(type, data);
            }

            pendingChanges.clear();
            showToast('Published successfully!', 'success');
        }

        async function saveToGitHub(type, data) {
            const filePath = GITHUB_DATA_FILES[type];
            const varName = GITHUB_VAR_NAMES[type];
            if (!filePath || !varName) return;

            let fileContent;
            if (type === 'content') {
                fileContent = `export const defaultContent = ${JSON.stringify(data, null, 2)};`;
            } else {
                fileContent = `var ${varName} = ${JSON.stringify(data, null, 2)};`;
            }

            await writeFileToGitHub(filePath, fileContent, `Update ${type} via Admin Panel`);

            // content.js now lives only in web/  no duplicate to sync
        }

        async function writeFileToGitHub(filePath, fileContent, message) {
            const apiUrl = `https://api.github.com/repos/${gitHubConfig.owner}/${gitHubConfig.repo}/contents/${filePath}`;
            let sha = null;
            try {
                const getRes = await fetch(apiUrl, {
                    headers: { 'Authorization': `token ${gitHubConfig.token}` }
                });
                if (getRes.ok) {
                    const fileData = await getRes.json();
                    sha = fileData.sha;
                }
            } catch(e) {}

            const body = {
                message: message,
                content: btoa(unescape(encodeURIComponent(fileContent))),
                branch: gitHubConfig.branch
            };
            if (sha) body.sha = sha;

            await fetch(apiUrl, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${gitHubConfig.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });
        }

        // Utilities
        function escapeHTML(str) {
            if (typeof str !== 'string') return str;
            return str.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c]));
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Handle photo upload from device
        function handlePhotoUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showToast('Please select an image file', 'error');
                return;
            }

            // Validate file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast('Image must be under 2MB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                
                // Update preview
                const preview = document.getElementById('photo-preview');
                if (preview) {
                    preview.innerHTML = `<img src="${base64}" alt="Preview">`;
                }
                
                // Update hidden field with base64 data
                const photoInput = document.getElementById('form-photo');
                if (photoInput) {
                    photoInput.value = base64;
                }
                
                showToast('Photo uploaded!', 'success');
            };
            reader.readAsDataURL(file);
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle'}"></i> ${message}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // ===== AI INTEGRATION (GROQ) =====
        const AI_CONFIG_KEY = 'svgt_ai_config';
        
        function getAIConfig() {
            const saved = localStorage.getItem(AI_CONFIG_KEY);
            return saved ? JSON.parse(saved) : { apiKey: '', model: 'llama-3.3-70b-versatile' };
        }
        
        function saveAIConfig() {
            const config = {
                apiKey: document.getElementById('groq-api-key').value,
                model: document.getElementById('groq-model').value
            };
            localStorage.setItem(AI_CONFIG_KEY, JSON.stringify(config));
            showToast('AI settings saved!', 'success');
        }
        
        function loadAIConfig() {
            const config = getAIConfig();
            const apiKeyInput = document.getElementById('groq-api-key');
            const modelSelect = document.getElementById('groq-model');
            if (apiKeyInput) apiKeyInput.value = config.apiKey || '';
            if (modelSelect) modelSelect.value = config.model || 'llama-3.3-70b-versatile';
        }
        
        async function callGroqAPI(prompt, systemPrompt = 'You are a helpful assistant.') {
            const config = getAIConfig();
            if (!config.apiKey) {
                showToast('Please configure AI API key in Settings', 'error');
                throw new Error('No API key configured');
            }
            
            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${config.apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: config.model,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: prompt }
                    ],
                    temperature: 0.7,
                    max_tokens: 1024
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API request failed');
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        async function testAI() {
            try {
                showToast('Testing AI connection...', 'info');
                const result = await callGroqAPI('Say "Hello! AI is working perfectly." in exactly those words.');
                showToast('AI connected successfully!', 'success');
            } catch (error) {
                showToast('AI connection failed: ' + error.message, 'error');
            }
        }
        
        async function generateBio(name, role) {
            const prompt = `Write a professional 2-3 sentence biography for ${name}, who works as ${role} at SapthaVarnah Geo Technologies, a company specializing in marine infrastructure and geo-engineering consultancy. Keep it concise and professional.`;
            const systemPrompt = 'You are a professional copywriter. Write clear, engaging biographies. Do not use quotation marks around the output.';
            return await callGroqAPI(prompt, systemPrompt);
        }
        
        async function generateDescription(title, type = 'service') {
            const prompt = `Write a professional 2-3 sentence description for a ${type} called "${title}" offered by SapthaVarnah Geo Technologies, a marine infrastructure and geo-engineering consultancy company. Keep it clear and compelling.`;
            const systemPrompt = 'You are a professional copywriter for an engineering consultancy. Write technical but accessible descriptions. Do not use quotation marks around the output.';
            return await callGroqAPI(prompt, systemPrompt);
        }
        
        async function improveText(text) {
            const prompt = `Improve the following text while keeping the same meaning and length. Make it more professional and engaging:\n\n${text}`;
            const systemPrompt = 'You are a professional editor. Improve text clarity and professionalism. Return only the improved text without quotation marks.';
            return await callGroqAPI(prompt, systemPrompt);
        }
        
        // ===== AI FORM HELPERS =====
        async function aiGenerateBio() {
            const name = document.getElementById('form-name')?.value || '';
            const role = document.getElementById('form-role')?.value || '';
            
            if (!name || !role) {
                showToast('Please enter name and role first', 'error');
                return;
            }
            
            try {
                showToast('Generating bio...', 'info');
                const bio = await generateBio(name, role);
                document.getElementById('form-bio').value = bio;
                showToast('Bio generated!', 'success');
            } catch (error) {
                showToast('Failed to generate bio: ' + error.message, 'error');
            }
        }
        
        async function aiGenerateDescription() {
            const title = document.getElementById('form-title')?.value || '';
            const category = document.getElementById('form-category')?.value || '';
            
            if (!title) {
                showToast('Please enter a title first', 'error');
                return;
            }
            
            try {
                showToast('Generating description...', 'info');
                const desc = await generateDescription(title + (category ? ` (${category})` : ''));
                document.getElementById('form-description').value = desc;
                showToast('Description generated!', 'success');
            } catch (error) {
                showToast('Failed to generate description: ' + error.message, 'error');
            }
        }
        
        async function aiImproveField(fieldId) {
            const field = document.getElementById(fieldId);
            if (!field || !field.value.trim()) {
                showToast('Please enter some text first', 'error');
                return;
            }
            
            try {
                showToast('Improving text...', 'info');
                const improved = await improveText(field.value);
                field.value = improved;
                showToast('Text improved!', 'success');
            } catch (error) {
                showToast('Failed to improve text: ' + error.message, 'error');
            }
        }
        
        async function aiTranslate(text, targetLang = 'Hindi') {
            const prompt = `Translate the following text to ${targetLang}. Return only the translation:\n\n${text}`;
            const systemPrompt = 'You are a professional translator. Translate accurately and naturally.';
            return await callGroqAPI(prompt, systemPrompt);
        }
        
        async function aiSummarize(text) {
            const prompt = `Summarize the following text in 1-2 sentences:\n\n${text}`;
            const systemPrompt = 'You are an expert at concise summaries.';
            return await callGroqAPI(prompt, systemPrompt);
        }
        
        async function aiGenerateSEO(title) {
            const prompt = `Generate SEO meta description (max 160 characters) for a page titled "${title}" on SapthaVarnah Geo Technologies website. The company specializes in marine infrastructure and geo-engineering consultancy.`;
            const systemPrompt = 'You are an SEO expert. Write compelling meta descriptions that drive clicks.';
            return await callGroqAPI(prompt, systemPrompt);
        }
        
        async function aiGenerateTagline() {
            try {
                showToast('Generating tagline...', 'info');
                const prompt = 'Generate a professional tagline for SapthaVarnah Geo Technologies, a marine infrastructure and geo-engineering consultancy. Keep it under 10 words.';
                const result = await callGroqAPI(prompt, 'You are a branding expert. Write memorable taglines.');
                showToast('Tagline: ' + result, 'success');
                return result;
            } catch (error) {
                showToast('Failed: ' + error.message, 'error');
            }
        }
        
        // ===== UNIVERSAL AI FOR CONTENT FIELDS =====
        function isAIEligibleField(label) {
            const skip = ['icon', 'link', 'url', 'email', 'id ', '(slug)', 'image', 'filename', 'phone', 'photo', 'logo'];
            return !skip.some(t => label.toLowerCase().includes(t));
        }

        async function aiEnhanceField(fieldId, fieldLabel, page, section) {
            const field = document.getElementById(fieldId);
            if (!field) return;
            const currentValue = field.value.trim();
            const companyCtx = 'SapthaVarnah Geo Technologies (SVGT), a specialist infrastructure and geo-engineering company focused on marine, transport, energy sectors across Africa, India, and the Gulf';
            let prompt;
            if (!currentValue) {
                prompt = `Generate professional content for the "${fieldLabel}" field on the "${page} > ${section}" section of an infrastructure engineering company website. Company: ${companyCtx}. Keep it concise (2-3 sentences for descriptions, short phrase for titles/labels). Return only the text.`;
            } else {
                prompt = `Improve the following text for the "${fieldLabel}" field. Make it more professional, compelling, and polished while keeping the same meaning and approximate length. Return only the improved text:\n\n${currentValue}`;
            }
            const btn = field.closest('.form-group')?.querySelector('.ai-field-btn');
            try {
                if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; }
                const result = await callGroqAPI(prompt, 'You are a professional copywriter for an engineering infrastructure company. Write clear, compelling, technically credible content. Return only the content text, no quotes or labels.');
                field.value = result;
                field.dispatchEvent(new Event('change'));
                showToast(currentValue ? 'Text improved!' : 'Content generated!', 'success');
            } catch (e) {
                showToast('AI failed: ' + e.message, 'error');
            } finally {
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i>'; }
            }
        }

        async function aiGenerateArrayItem(page, section) {
            const schema = CONTENT_SCHEMA[page]?.sections?.[section];
            if (!schema || !schema.fields) { showToast('No schema for this section', 'error'); return; }
            const fieldNames = Object.entries(schema.fields).filter(([k, v]) => isAIEligibleField(v.label)).map(([k, v]) => `${k} (${v.label})`);
            const allFields = Object.keys(schema.fields);
            const prompt = `Generate content for a new "${schema.itemLabel}" entry for the "${page}" page of an infrastructure engineering company (SapthaVarnah Geo Technologies). Generate values for these fields: ${fieldNames.join(', ')}. Return as a JSON object with keys: ${allFields.join(', ')}. For icon fields use FontAwesome class names like fa-anchor, fa-water, etc. For link fields use # placeholder.`;
            try {
                showToast('Generating ' + schema.itemLabel + '...', 'info');
                const result = await callGroqAPI(prompt, 'Return valid JSON only. No markdown code fences. No explanation.');
                let parsed;
                try { parsed = JSON.parse(result.replace(/```json?\n?/g, '').replace(/```/g, '').trim()); } catch(e) { throw new Error('Failed to parse AI response as JSON'); }
                if (!contentWorkingCopy[page]) contentWorkingCopy[page] = {};
                if (!contentWorkingCopy[page][section]) contentWorkingCopy[page][section] = [];
                const newItem = {};
                for (const key of allFields) { newItem[key] = parsed[key] || ''; }
                contentWorkingCopy[page][section].push(newItem);
                pendingChanges.add('content');
                renderContentEditor(currentContentPage);
                showToast(schema.itemLabel + ' generated!', 'success');
            } catch (e) {
                showToast('AI generation failed: ' + e.message, 'error');
            }
        }

        // AI Chat Assistant
        let aiChatOpen = false;
        let aiChatHistory = [];
        
        function initAIChat() {
            // Create floating AI button
            const aiBtn = document.createElement('button');
            aiBtn.id = 'ai-chat-btn';
            aiBtn.className = 'ai-fab';
            aiBtn.innerHTML = '<i class="fas fa-robot"></i>';
            aiBtn.onclick = toggleAIChat;
            document.body.appendChild(aiBtn);
            
            // Create chat container
            const chatContainer = document.createElement('div');
            chatContainer.id = 'ai-chat-container';
            chatContainer.className = 'ai-chat-container';
            chatContainer.innerHTML = `
                <div class="ai-chat-header">
                    <span><i class="fas fa-robot"></i> AI Assistant</span>
                    <button type="button" onclick="toggleAIChat()" class="ai-chat-close">&times;</button>
                </div>
                <div class="ai-chat-messages" id="ai-chat-messages">
                    <div class="ai-message ai">Hello! I'm your AI assistant powered by Groq. How can I help you with your content today?</div>
                </div>
                <div class="ai-chat-input">
                    <input type="text" id="ai-chat-input" placeholder="Ask me anything..." onkeypress="if(event.key==='Enter')sendAIMessage()">
                    <button type="button" onclick="sendAIMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            `;
            document.body.appendChild(chatContainer);
            
            // Add AI chat styles
            const style = document.createElement('style');
            style.textContent = `
                .ai-fab {
                    position: fixed;
                    bottom: 30px;
                    right: 30px;
                    width: 60px;
                    height: 60px;
                    border-radius: 50%;
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    border: none;
                    color: white;
                    font-size: 24px;
                    cursor: pointer;
                    box-shadow: 0 4px 20px rgba(102,126,234,0.4);
                    z-index: 9999;
                    transition: transform 0.3s, box-shadow 0.3s;
                }
                .ai-fab:hover {
                    transform: scale(1.1);
                    box-shadow: 0 6px 30px rgba(102,126,234,0.6);
                }
                .ai-chat-container {
                    position: fixed;
                    bottom: 100px;
                    right: 30px;
                    width: 380px;
                    height: 500px;
                    background: var(--bg-color);
                    border-radius: 16px;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                    display: none;
                    flex-direction: column;
                    z-index: 9998;
                    overflow: hidden;
                }
                .ai-chat-container.open {
                    display: flex;
                }
                .ai-chat-header {
                    padding: 16px 20px;
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    color: white;
                    font-weight: 600;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                .ai-chat-close {
                    background: none;
                    border: none;
                    color: white;
                    font-size: 24px;
                    cursor: pointer;
                }
                .ai-chat-messages {
                    flex: 1;
                    overflow-y: auto;
                    padding: 16px;
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                }
                .ai-message {
                    padding: 12px 16px;
                    border-radius: 12px;
                    max-width: 85%;
                    line-height: 1.5;
                }
                .ai-message.user {
                    background: var(--accent);
                    color: white;
                    align-self: flex-end;
                    border-bottom-right-radius: 4px;
                }
                .ai-message.ai {
                    background: var(--card-bg);
                    color: var(--text-primary);
                    align-self: flex-start;
                    border-bottom-left-radius: 4px;
                }
                .ai-message.loading {
                    opacity: 0.7;
                }
                .ai-chat-input {
                    display: flex;
                    padding: 12px;
                    gap: 8px;
                    border-top: 1px solid var(--border);
                }
                .ai-chat-input input {
                    flex: 1;
                    padding: 12px 16px;
                    border-radius: 24px;
                    border: 1px solid var(--border);
                    background: var(--card-bg);
                    color: var(--text-primary);
                    outline: none;
                }
                .ai-chat-input button {
                    width: 44px;
                    height: 44px;
                    border-radius: 50%;
                    border: none;
                    background: var(--accent);
                    color: white;
                    cursor: pointer;
                }
                .ai-gen-btn {
                    margin-left: 8px;
                    padding: 6px 12px;
                    font-size: 12px;
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    border: none;
                    color: white;
                    border-radius: 6px;
                    cursor: pointer;
                }
                .ai-gen-btn:hover {
                    opacity: 0.9;
                }
            `;
            document.head.appendChild(style);
        }
        
        function toggleAIChat() {
            const container = document.getElementById('ai-chat-container');
            if (container) {
                aiChatOpen = !aiChatOpen;
                container.classList.toggle('open', aiChatOpen);
            }
        }
        
        async function sendAIMessage() {
            const input = document.getElementById('ai-chat-input');
            const messages = document.getElementById('ai-chat-messages');
            const userMessage = input.value.trim();
            
            if (!userMessage) return;
            
            // Add user message
            messages.innerHTML += `<div class="ai-message user">${userMessage}</div>`;
            input.value = '';
            
            // Add loading message
            const loadingId = 'loading-' + Date.now();
            messages.innerHTML += `<div class="ai-message ai loading" id="${loadingId}"><i class="fas fa-spinner fa-spin"></i> Thinking...</div>`;
            messages.scrollTop = messages.scrollHeight;
            
            try {
                const systemPrompt = `You are an AI assistant for SapthaVarnah Geo Technologies admin panel. Help with content creation, writing team bios, service descriptions, and general questions. Be concise and helpful. The company specializes in marine infrastructure and geo-engineering consultancy.`;
                const response = await callGroqAPI(userMessage, systemPrompt);
                
                // Replace loading with response
                document.getElementById(loadingId).outerHTML = `<div class="ai-message ai">${response}</div>`;
                aiChatHistory.push({ user: userMessage, ai: response });
            } catch (error) {
                document.getElementById(loadingId).outerHTML = `<div class="ai-message ai" style="color:#e74c3c;">Error: ${error.message}</div>`;
            }
            
            messages.scrollTop = messages.scrollHeight;
        }
        
        // Initialize AI chat on load
        document.addEventListener('DOMContentLoaded', () => {
            loadAIConfig();
            initAIChat();
        });
    </script>
</body>
</html>
